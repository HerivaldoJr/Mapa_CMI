<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cidade Mais Infância - Dashboard Geográfico Profissional</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --ceara-color: #ff4757;
            --sidebar-bg: #ffffff;
            --map-bg: #f4f7f6;
            --text-dark: #1a2a3a;
            --text-muted: #666;
            --label-bg: rgba(255, 255, 255, 0.95);
            --label-border-color: var(--primary-color);
            --label-text-color: var(--primary-color);
            --label-font-size: 12px;
            --label-padding-vertical: 2px;
            --label-padding-horizontal: 6px;
            --label-padding: var(--label-padding-vertical) var(--label-padding-horizontal);
            --label-radius: 12px;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            
            --theme-state-color-1: #08306b;
            --theme-state-color-2: #084594;
            --theme-state-color-3: #2171b5;
            --theme-state-color-4: #4292c6;
            --theme-state-color-5: #6baed6;
            --theme-state-color-6: #9ecae1;
            --theme-state-color-0: #eff3ff;
            
            --classic-state-color-1: #08306b;
            --classic-state-color-2: #084594;
            --classic-state-color-3: #2171b5;
            --classic-state-color-4: #4292c6;
            --classic-state-color-5: #6baed6;
            --classic-state-color-6: #9ecae1;
            --classic-state-color-0: #eff3ff;
            
            --idh-very-high: #27ae60;
            --idh-high: #52be80;
            --idh-medium: #f39c12;
            --idh-low: #e74c3c;
            --idh-very-low: #c0392b;
            --idh-no-data: #e0e0e0;
            
            --current-theme: 'classic';
        }

        .state-label {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 2px solid var(--primary-color, #007bff) !important;
            border-radius: var(--label-radius, 12px) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
            cursor: move !important;
            user-select: none !important;
            padding: var(--label-padding, 4px 8px) !important;
            min-width: 30px !important;
            text-align: center !important;
            line-height: 1.3 !important;
            font-weight: 600 !important;
            color: var(--primary-color, #007bff) !important;
            letter-spacing: 0.2px !important;
            background-color: white !important;
            position: relative !important;
            white-space: nowrap;
            font-size: var(--label-font-size, 11px) !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .state-label:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
            z-index: 2000 !important;
        }

        .state-label.highlight-ce {
            background: var(--ceara-color, #ff4757) !important;
            border-color: #d63031 !important;
            color: white !important;
            font-size: var(--label-font-size, 11px) !important;
            z-index: 1001 !important;
            box-shadow: 0 4px 12px rgba(255,71,87,0.4) !important;
            padding: var(--label-padding, 4px 8px) !important;
            transform: scale(1.02);
        }

        .state-label.highlight-ce:hover {
            transform: scale(1.05) !important;
        }

        .state-label.highlight-ce::after {
            content: '' !important;
            position: absolute !important;
            bottom: -12px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 0 !important;
            height: 0 !important;
            border-left: 10px solid transparent !important;
            border-right: 10px solid transparent !important;
            border-top: 10px solid #d63031 !important;
            z-index: 1001 !important;
        }

        .state-label.highlight-ce:hover::after {
            border-top-color: #b71c1c !important;
        }

        .state-label b {
            display: block !important;
            font-size: 1.1em !important;
            margin-bottom: 2px !important;
            font-weight: 700 !important;
            line-height: 1.2 !important;
        }

        .state-label.highlight-ce b {
            color: white !important;
        }

        .state-label .visitas-number {
            display: block !important;
            font-size: 0.9em !important;
            font-weight: 600 !important;
            opacity: 0.9 !important;
            margin-top: 0 !important;
        }

        .state-label div[id^="check-"] {
            margin-top: 4px !important;
            padding-top: 2px !important;
            border-top: 1px dashed rgba(13, 110, 253, 0.3) !important;
            white-space: normal;
            width: 100% !important;
            font-size: 0.8em !important;
        }
        .state-label.highlight-ce div[id^="check-"] {
            border-top-color: rgba(255, 255, 255, 0.4) !important;
        }

        .state-label-container {
            background: transparent !important;
            border: none !important;
        }

        .theme-modern .stats-table tr:hover {
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%) !important;
        }
        .theme-modern .badge-count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        .theme-modern .total-counter {
            border-left-color: #667eea !important;
        }

        .theme-modern .state-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border: none !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3) !important;
            padding: var(--label-padding, 4px 8px) !important;
        }
        .theme-modern .state-label.highlight-ce {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%) !important;
        }
        .theme-modern .state-label.highlight-ce::after {
            border-top-color: #ee5253 !important;
        }
        .theme-modern .state-label.highlight-ce:hover::after {
            border-top-color: #d63031 !important;
        }
        .theme-modern .state-label:hover {
            transform: translateY(-2px) !important;
        }

        html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; background: var(--map-bg); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        .sidebar {
            position: fixed; top: 20px; left: 20px; width: 380px; max-height: 92vh;
            z-index: 1000; background: var(--sidebar-bg); padding: 0; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); overflow: hidden;
            display: flex; flex-direction: column; transition: all 0.3s ease;
        }
        
        .sidebar-header { padding: 20px; background: #fff; text-align: center; border-bottom: 1px solid #eee; position: relative; }
        .sidebar-header img { max-width: 180px; margin-bottom: 10px; }
        .admin-toggle { position: absolute; top: 15px; right: 15px; cursor: pointer; color: var(--text-muted); font-size: 18px; transition: all 0.2s; }
        .admin-toggle:hover { color: var(--primary-color); transform: rotate(90deg); }
        
        .sidebar-content { padding: 0 20px 20px 20px; overflow-y: auto; flex-grow: 1; }
        
        .nav-map-levels {
            display: flex;
            background: #f1f3f5;
            padding: 5px;
            border-radius: 12px;
            margin: 15px 20px 0 20px;
        }
        .nav-map-levels button {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            color: #666;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .nav-map-levels button.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }
        
        .stats-card { background: #f8f9fa; border-radius: 15px; padding: 15px; margin-top: 15px; border: 1px solid #e9ecef; }
        .stats-table { width: 100%; font-size: 13px; border-collapse: collapse; }
        .stats-table th { color: #888; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; padding: 8px 0; border-bottom: 2px solid #eee; }
        .stats-table td { padding: 10px 0; border-bottom: 1px solid #eee; color: var(--text-dark); }
        .stats-table tr:hover { background: #f0f7ff; cursor: pointer; }
        
        .badge-count { background: #e7f1ff; color: var(--primary-color); padding: 4px 10px; border-radius: 20px; font-weight: 700; float: right; }
        .badge-idh { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 12px; font-weight: 600; font-size: 11px; margin-left: 5px; }

        .legend { padding: 15px; background: white; line-height: 24px; color: #333; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 13px; max-height: 400px; overflow-y: auto; }
        .legend i { width: 20px; height: 20px; float: left; margin-right: 12px; opacity: 0.8; border-radius: 4px; }
        .legend-item { cursor: pointer; display: flex; align-items: center; padding: 4px 8px; border-radius: 6px; transition: all 0.3s ease; }
        .legend-item:hover { background: #f0f7ff; transform: translateX(5px); }
        .legend-item.active { background: #e7f1ff; font-weight: 700; color: var(--primary-color); border: 1px solid var(--primary-color); }

        #adminPanel {
            display: none;
            position: fixed;
            top: 20px;
            right: 70px;
            width: 600px;
            background: white;
            z-index: 1100;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        #detailsPanel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: white;
            z-index: 1200;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
        }

        .details-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1150;
            animation: fadeIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translate(-50%, -40%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .presentation-mode .sidebar, 
        .presentation-mode #adminPanel, 
        .presentation-mode .leaflet-control-zoom,
        .presentation-mode .leaflet-control-draw,
        .presentation-mode .admin-toggle,
        .presentation-mode .map-footer,
        .presentation-mode .presentation-toggle-btn {
            display: none !important;
        }

        .presentation-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 25px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .btn-pres {
            border: none; background: none; color: #333; font-weight: 700;
            display: flex; align-items: center; gap: 8px; padding: 8px 15px;
            border-radius: 25px; transition: all 0.2s; cursor: pointer;
        }

        .btn-pres:hover { background: #eee; color: #007bff; }
        .btn-pres.active { background: #007bff; color: white; }

        .floating-card {
            position: fixed; top: 30px; right: 30px; width: 350px;
            background: white; border-radius: 20px; box-shadow: 0 15px 45px rgba(0,0,0,0.2);
            z-index: 2500; padding: 25px; border-left: 6px solid #ff4757;
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight { from { transform: translateX(120%); } to { transform: translateX(0); } }

        .chart-container { width: 100%; height: 220px; margin-top: 15px; }

        .ceara-particle {
            position: absolute; pointer-events: none; background: #ff4757;
            border-radius: 50%; z-index: 4000; animation: particleOut 1s ease-out forwards;
        }

        @keyframes particleOut {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .presentation-toggle-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 3001;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
            cursor: pointer;
            opacity: 0.7;
        }

        .presentation-toggle-btn.visible {
            display: flex !important;
        }

        .presentation-toggle-btn:hover {
            opacity: 1;
            transform: scale(1.05);
            background: #007bff;
        }

        .tour-timer-bar {
            position: absolute; bottom: 0; left: 0; height: 5px;
            background: #007bff; width: 0%; transition: width linear;
        }

        .admin-header h5 { margin: 0; font-weight: 700; color: var(--text-dark); }
        
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; }
        .state-edit-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 10px; transition: all 0.2s; }
        .state-edit-row:hover { background: #e7f1ff; }
        .state-edit-row b { width: 100px; font-size: 11px; overflow: hidden; text-overflow: ellipsis; }
        .state-edit-row input { flex-grow: 1; }

        .idh-edit-row { display: flex; align-items: center; gap: 4px; margin-bottom: 8px; padding: 8px; background: #f0f8ff; border-radius: 8px; border-left: 3px solid #007bff; }
        .idh-edit-row small { flex: 1; font-weight: 600; }
        .idh-edit-row input { width: 80px; }

        .new-item-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .new-item-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 5px;
        }
        
        .new-item-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 8px;
        }
        
        .new-item-row label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            min-width: 100px;
        }
        
        .new-item-row input {
            flex: 1;
        }
        
        .new-item-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .new-item-actions button {
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 15px; }
        .details-header h3 { margin: 0; color: var(--text-dark); font-weight: 800; }
        .details-close { cursor: pointer; font-size: 24px; color: #999; }
        .details-close:hover { color: #333; }

        .details-stat { margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 10px; }
        .details-stat-label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        .details-stat-value { font-size: 24px; font-weight: 800; color: var(--primary-color); margin-top: 5px; }

        .details-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .details-actions button { padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .details-actions button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .alert-warning-custom { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 12px; }

        .view-mode-selector {
            background: #fff;
            padding: 10px 15px;
            border-radius: 12px;
            margin: 10px 20px 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        .view-mode-selector label {
            font-size: 11px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .sidebar { width: calc(100% - 40px); max-height: 45vh; top: auto; bottom: 20px; }
            #adminPanel { width: calc(100% - 40px); right: 20px; left: 20px; }
            #detailsPanel { width: calc(100% - 40px); }
        }

        .map-footer {
            position: fixed;
            bottom: 15px;
            left: 20px;
            z-index: 900;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.7);
            background: rgba(255, 255, 255, 0.4);
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
            letter-spacing: 0.4px;
            pointer-events: auto;
            text-shadow: 0 1px 1px rgba(255,255,255,0.8);
            backdrop-filter: blur(2px);
            white-space: normal;
            border-left: 3px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            line-height: 1.5;
            text-align: left;
            font-family: 'Segoe UI Semibold', 'Roboto', sans-serif;
        }

        .map-footer:hover {
            color: var(--primary-color);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .map-footer span#footer-year {
            font-weight: 800;
            color: var(--primary-color);
        }

        .footer-signature {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
            color: #444;
            margin-top: 2px;
            display: block;
        }

        .total-counter {
            background: white;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        .total-counter:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .total-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .total-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1.2;
        }
        .total-sub {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }

        .toast.success { border-left-color: #28a745; }
        .toast.error { border-left-color: #dc3545; }
        .toast.warning { border-left-color: #ffc107; }
        .toast.info { border-left-color: #17a2b8; }

        .toast i { font-size: 18px; }
        .toast .message { flex: 1; font-size: 13px; font-weight: 500; }
        .toast .close { cursor: pointer; color: #999; font-size: 14px; }
        .toast .close:hover { color: #333; }

        .saving-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
        }
        .saving-indicator i { font-size: 14px; }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .comparison-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--primary-color);
            display: none;
        }
        .comparison-panel h6 { 
            margin: 0 0 10px 0; 
            color: var(--primary-color); 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .comparison-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .comparison-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .comparison-item .name { font-weight: 600; }
        .comparison-item .value { color: var(--primary-color); }
        .comparison-stats {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
        }
        .comparison-stats .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .data-source-panel {
            background: #e8f4f8;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #17a2b8;
            font-size: 12px;
            display: none;
        }
        .data-source-panel a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
            word-break: break-all;
        }
        .data-source-panel a:hover {
            text-decoration: underline;
        }
        .data-source-panel small {
            color: #666;
            display: block;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 15px 0;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #adb5bd;
        }
        .empty-state h6 {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }
        .empty-state p {
            font-size: 12px;
            margin-bottom: 0;
        }
        
        .estado-edit-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .estado-edit-row .sigla-input {
            width: 50px !important;
            text-transform: uppercase;
            font-weight: 800;
            background: #e7f1ff;
            border: 2px solid var(--primary-color);
        }
        .estado-edit-row .nome-input {
            flex: 2;
        }
        .estado-edit-row .visitas-input {
            width: 80px;
        }
        .estado-edit-row .btn-group {
            display: flex;
            gap: 4px;
        }

        .total-estados-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        .total-estados-info .total {
            font-size: 24px;
            font-weight: 800;
        }
        .total-estados-info .label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        .quick-add-state {
            display: grid;
            grid-template-columns: 50px 1fr 80px auto;
            gap: 5px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 2px dashed var(--primary-color);
        }
        .quick-add-state input {
            font-size: 12px;
        }

        .import-auto-panel {
            background: #f0f8ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--primary-color);
        }
        .import-auto-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .import-auto-header i {
            font-size: 24px;
            color: var(--primary-color);
        }
        .import-auto-header h6 {
            margin: 0;
            font-weight: 700;
            color: var(--text-dark);
        }
        .import-auto-description {
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
        }
        .import-preview {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 8px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }
        .import-preview-item {
            font-size: 11px;
            padding: 2px 0;
            border-bottom: 1px dashed #eee;
        }

        .file-upload-container {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            color: white;
            border: 2px solid #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .file-upload-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .file-upload-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 700;
        }
        
        .file-upload-header i {
            font-size: 28px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        
        .file-input-button {
            background: white;
            color: #2575fc;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .file-input-button:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .selected-file-info {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 12px;
            display: none;
        }
        
        .statistical-analysis {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            color: white;
            border: 2px solid #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            display: none;
        }
        
        .statistical-analysis.visible {
            display: block;
        }
        
        .statistical-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 700;
        }
        
        .statistical-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .statistical-item {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        
        .statistical-label {
            font-size: 10px;
            opacity: 0.8;
            text-transform: uppercase;
        }
        
        .statistical-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .statistical-small {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .ranking-container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            border-left: 3px solid #ffd700;
        }
        
        .ranking-title {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 3px 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        
        .ranking-item .position {
            font-weight: 700;
            margin-right: 5px;
            color: #ffd700;
        }
        
        .ranking-item .name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ranking-item .value {
            font-weight: 700;
            color: #fff;
        }
        
        .ranking-divider {
            height: 1px;
            background: rgba(255,255,255,0.3);
            margin: 8px 0;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            height: 150px;
            position: relative;
        }
        
        .version-history {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }
        
        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .version-list {
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            font-size: 11px;
        }
        
        .version-item:hover {
            background: #e9ecef;
        }
        
        .version-actions {
            display: flex;
            gap: 5px;
        }
        
        .version-actions button {
            padding: 2px 8px;
            font-size: 10px;
        }
        
        .idh-tab-hidden {
            display: none !important;
        }

        .container-hidden {
            display: none !important;
        }
        .container-visible {
            display: block !important;
        }

        .btn-group-xs > .btn, .btn-xs {
            padding: 0.25rem 0.4rem;
            font-size: 0.7rem;
            line-height: 1.2;
            border-radius: 0.2rem;
        }

        .import-confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .import-confirm-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .import-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .import-summary-item.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .import-summary-item.success {
            background: #d4edda;
            color: #155724;
        }
        
        .import-summary-item.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .import-options {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .import-radio-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .import-radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .data-version-history {
            font-size: 11px;
            color: #666;
            margin-top: 10px;
            padding: 8px;
            background: #e9ecef;
            border-radius: 5px;
            display: none;
        }
        
        .progress-import {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-import-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .duplicate-resolution {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            border-left: 3px solid #ffc107;
        }

        .validation-error {
            color: #dc3545;
            font-size: 11px;
            margin-top: 2px;
        }
        
        .validation-warning {
            color: #856404;
            font-size: 11px;
            margin-top: 2px;
        }
        
        .import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .import-stat-item {
            text-align: center;
        }
        
        .import-stat-value {
            font-size: 24px;
            font-weight: 800;
            line-height: 1.2;
        }
        
        .import-stat-label {
            font-size: 10px;
            opacity: 0.9;
            text-transform: uppercase;
        }
        
        .backup-timeline {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .backup-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .backup-item:last-child {
            border-bottom: none;
        }
        
        .backup-time {
            font-size: 11px;
            color: #666;
        }
        
        .backup-restore {
            cursor: pointer;
            color: #007bff;
            font-size: 12px;
        }
        
        .backup-restore:hover {
            text-decoration: underline;
        }

        .json-package-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .json-package-info {
            background: #f0f8ff;
            border: 2px solid #764ba2;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .outlier-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-size: 10px;
        }
        
        .trend-up { color: #27ae60; }
        .trend-down { color: #e74c3c; }
        .trend-stable { color: #f39c12; }
        
        .feature-toggle {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            color: white;
        }
        .feature-toggle .form-check-input:checked {
            background-color: #f1c40f;
            border-color: #f1c40f;
        }
        
        .stat-panel {
            display: block !important;
        }
        .stat-panel.visible {
            display: block;
        }

        .theme-selector {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            color: white;
        }
        .theme-selector .form-select {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
        }
        .theme-selector .form-select option {
            background-color: #333;
            color: white;
        }

        .force-button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            color: white;
            font-weight: 700;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
            margin-bottom: 15px;
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .force-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .force-button i {
            font-size: 16px;
        }
        
        .cache-clear-button {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            color: white;
            font-weight: 700;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
            margin-bottom: 15px;
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .cache-clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .cache-clear-button i {
            font-size: 16px;
        }
        
        .balloon-size-control {
            margin-bottom: 15px;
        }
        .balloon-size-control .d-flex {
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body class="theme-classic">

<div class="sidebar">
    <div class="sidebar-header">
        <div class="admin-toggle" onclick="toggleAdmin()" title="Configurações Avançadas">
            <i class="fas fa-cog"></i>
        </div>
        <img src="https://cidademaisinfancia.sps.ce.gov.br/assets/images/logo-completa.png" alt="Cidade Mais Infância">
        <h5 id="main-system-title" style="margin:0; color:var(--text-dark); font-weight:700">Monitoramento de Visitas</h5>
    </div>
    
    <div class="nav-map-levels">
        <button class="btn btn-sm btn-outline-secondary" onclick="fitMap()" title="Resetar Zoom"><i class="fas fa-expand-arrows-alt"></i></button>
        <button id="btn-lvl-brasil" class="active" onclick="switchLevel('brasil')">BRASIL</button>
        <button id="btn-lvl-ceara" onclick="switchLevel('ceara')">CEARÁ</button>
        <button id="btn-lvl-fortaleza" onclick="switchLevel('fortaleza')">FORTALEZA</button>
    </div>

    <div id="view-mode-container" class="view-mode-selector" style="display:none;">
        <label>Visualização do Mapa</label>
        <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="viewMode" id="modeVisitas" value="visitas" checked onchange="changeViewMode(this.value)">
            <label class="btn btn-outline-primary btn-sm" for="modeVisitas">Visitantes</label>
            <input type="radio" class="btn-check" name="viewMode" id="modeIDH" value="idh" onchange="changeViewMode(this.value)">
            <label class="btn btn-outline-primary btn-sm" for="modeIDH">IDH</label>
        </div>
    </div>
    
    <div class="sidebar-content">
        <div id="level-info">
            <div id="data-source-panel" class="data-source-panel">
                <i class="fas fa-database me-1"></i> <strong>Fonte dos dados de IDH:</strong><br>
                <a href="https://dados.fortaleza.ce.gov.br/dataset/desenvolvimento_humano_bairro" target="_blank">
                    Desenvolvimento Humano, por Bairro de Fortaleza
                </a><br>
                <small>
                    <i class="far fa-calendar-alt me-1"></i> Dados atualizados em: 16 de novembro de 2022<br>
                    <i class="fas fa-file-excel me-1"></i> Fonte: Prefeitura de Fortaleza - Dados Abertos
                </small>
            </div>

            <div class="total-counter" id="totalCounter">
                <div class="total-label" id="totalLabel">Total de Visitas no Brasil</div>
                <div class="total-value" id="totalValue">0</div>
                <div class="total-sub" id="totalSub">Estados: 27</div>
            </div>

            <div id="statistical-analysis-panel" class="statistical-analysis">
                <div class="statistical-header">
                    <i class="fas fa-chart-pie"></i>
                    <span>Análise Estatística</span>
                </div>
                <div class="statistical-grid">
                    <div class="statistical-item">
                        <div class="statistical-label">Média</div>
                        <div class="statistical-value" id="stat-mean">0</div>
                    </div>
                    <div class="statistical-item">
                        <div class="statistical-label">Mediana</div>
                        <div class="statistical-value" id="stat-median">0</div>
                    </div>
                    <div class="statistical-item">
                        <div class="statistical-label">Desvio Padrão</div>
                        <div class="statistical-value" id="stat-std">0</div>
                    </div>
                    <div class="statistical-item">
                        <div class="statistical-label">Mínimo</div>
                        <div class="statistical-value" id="stat-min">0</div>
                    </div>
                    <div class="statistical-item">
                        <div class="statistical-label">Máximo</div>
                        <div class="statistical-value" id="stat-max">0</div>
                    </div>
                    <div class="statistical-item">
                        <div class="statistical-label">Total</div>
                        <div class="statistical-value" id="stat-total">0</div>
                    </div>
                </div>
                <div class="statistical-small" id="stat-outliers">
                    <i class="fas fa-exclamation-triangle me-1"></i> Outliers detectados: <span id="outlier-count">0</span>
                </div>
                
                <div class="ranking-container">
                    <div class="ranking-title">
                        <i class="fas fa-trophy" style="color: #ffd700;"></i>
                        <span>TOP 5 MAIS VISITADOS</span>
                    </div>
                    <div class="ranking-list" id="ranking-mais">
                        <div class="ranking-item"><span class="position">1º</span><span class="name">Carregando...</span><span class="value">0</span></div>
                    </div>
                    
                    <div class="ranking-divider"></div>
                    
                    <div class="ranking-title">
                        <i class="fas fa-arrow-down" style="color: #ff6b6b;"></i>
                        <span>5 MENOS VISITADOS</span>
                    </div>
                    <div class="ranking-list" id="ranking-menos">
                        <div class="ranking-item"><span class="position">1º</span><span class="name">Carregando...</span><span class="value">0</span></div>
                    </div>
                </div>
            </div>

            <div id="idh-comparison-panel" class="comparison-panel">
                <h6><i class="fas fa-chart-bar"></i> Comparativo IDH (<span id="comparison-count">0</span> selecionados)</h6>
                <div id="comparison-list" class="comparison-list"></div>
                <div id="comparison-stats" class="comparison-stats"></div>
            </div>

            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 id="stats-title" style="font-weight:700; margin:0; color:#444">Visitas por Estado</h6>
                    <div class="d-flex flex-column gap-1">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleLabels" checked onchange="toggleStateLabels(this.checked)">
                            <label class="form-check-label" for="toggleLabels" style="font-size: 10px; font-weight: 600; color: #666;">Exibir Números</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleNameLabels" onchange="toggleStateNameLabels(this.checked)">
                            <label class="form-check-label" for="toggleNameLabels" style="font-size: 10px; font-weight: 600; color: #666;">Exibir Nomes</label>
                        </div>
                    </div>
                </div>
                <table class="stats-table">
                    <thead><tr><th id="stats-col-name">Estado</th><th style="text-align:right">Visitas</th><th id="stats-col-idh" style="text-align:center;">IDH</th></tr></thead>
                    <tbody id="stats-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="details-overlay" id="detailsOverlay" onclick="closeDetails()"></div>

<div id="detailsPanel">
    <div class="details-header">
        <h3 id="details-title">Detalhes</h3>
        <span class="details-close" onclick="closeDetails()"><i class="fas fa-times"></i></span>
    </div>
    
    <div id="details-content"></div>
    
    <div class="details-actions">
        <button class="btn btn-primary" onclick="editDetailItem()"><i class="fas fa-edit me-1"></i> Editar</button>
        <button class="btn btn-danger" onclick="deleteCurrentItem()"><i class="fas fa-trash me-1"></i> Excluir</button>
        <button class="btn btn-secondary" style="grid-column: span 2;" onclick="closeDetails()"><i class="fas fa-times me-1"></i> Fechar</button>
    </div>
</div>

<div id="adminPanel">
    <div class="admin-header">
        <h5><i class="fas fa-tools me-2"></i>Administração</h5>
        <button type="button" class="btn-close" onclick="toggleAdmin()"></button>
    </div>
    
    <div class="d-flex gap-2 mb-3">
        <button class="force-button flex-fill" onclick="forceOperation()">
            <i class="fas fa-exclamation-triangle"></i> FORÇAR OPERAÇÃO
        </button>
        <button class="cache-clear-button flex-fill" onclick="clearCacheAndReload()">
            <i class="fas fa-broom"></i> LIMPAR CACHE
        </button>
    </div>
    
    <div class="mb-3">
        <label class="form-label">Nível de Edição</label>
        <select class="form-select form-select-sm" id="admin-level-select" onchange="changeAdminLevel(this.value)">
            <option value="brasil">Brasil (Estados)</option>
            <option value="ceara">Ceará (Municípios)</option>
            <option value="fortaleza">Fortaleza (Bairros)</option>
        </select>
    </div>

    <ul class="nav nav-pills nav-fill mb-3" id="adminTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active py-1" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button">Dados</button>
        </li>
        <li class="nav-item" id="idh-tab-item">
            <button class="nav-link py-1" id="idh-tab" data-bs-toggle="tab" data-bs-target="#idh-pane" type="button">IDH</button>
        </li>
        <li class="nav-item">
            <button class="nav-link py-1" id="pos-tab" data-bs-toggle="tab" data-bs-target="#pos-pane" type="button">Posição</button>
        </li>
        <li class="nav-item">
            <button class="nav-link py-1" id="style-tab" data-bs-toggle="tab" data-bs-target="#style-pane" type="button">Estilo</button>
        </li>
        <li class="nav-item">
            <button class="nav-link py-1" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-pane" type="button">Análise</button>
        </li>
        <li class="nav-item">
            <button class="nav-link py-1" id="io-tab" data-bs-toggle="tab" data-bs-target="#io-pane" type="button">Importar/Exportar</button>
        </li>
    </ul>
    
    <div class="tab-content" id="adminTabsContent">
        <div class="tab-pane fade show active" id="data-pane">
            <div id="total-estados-info" class="total-estados-info">
                <div class="label">Total de Visitantes nos Estados</div>
                <div class="total" id="total-estados-value">0</div>
            </div>

            <div id="state-edit-list" style="max-height: 300px; overflow-y: auto;"></div>
            
            <div id="add-estado-container" class="new-item-container">
                <div class="new-item-title">
                    <i class="fas fa-plus-circle me-2"></i>Adicionar Novo Estado
                </div>
                
                <div class="quick-add-state">
                    <input type="text" id="new-estado-sigla" class="form-control form-control-sm" placeholder="UF" maxlength="2" style="text-transform:uppercase">
                    <input type="text" id="new-estado-nome" class="form-control form-control-sm" placeholder="Nome do Estado">
                    <input type="number" id="new-estado-visitas" class="form-control form-control-sm" placeholder="Visitas" min="0" value="0">
                    <button class="btn btn-success btn-sm" onclick="addNewEstado()"><i class="fas fa-plus"></i></button>
                </div>
                
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i> Digite a sigla (UF) com 2 letras maiúsculas
                </small>
            </div>

            <div id="add-municipio-container" class="new-item-container">
                <div class="new-item-title">
                    <i class="fas fa-plus-circle me-2"></i>Adicionar Novo Município (Ceará)
                </div>
                
                <div class="new-item-row">
                    <label><i class="fas fa-map-marker-alt me-1"></i>Nome:</label>
                    <input type="text" id="new-municipio-name" class="form-control form-control-sm" placeholder="Ex: Sobral">
                </div>
                
                <div class="new-item-row">
                    <label><i class="fas fa-users me-1"></i>Visitantes:</label>
                    <input type="number" id="new-municipio-visitas" class="form-control form-control-sm" placeholder="0" min="0" value="0">
                </div>
                
                <div class="new-item-actions">
                    <button class="btn btn-success btn-sm" onclick="addNewMunicipio()">
                        <i class="fas fa-save me-1"></i> Salvar Município
                    </button>
                </div>
            </div>
            
            <div id="add-bairro-container" class="new-item-container">
                <div class="new-item-title">
                    <i class="fas fa-plus-circle me-2"></i>Adicionar Novo Bairro
                </div>
                
                <div class="new-item-row">
                    <label><i class="fas fa-map-marker-alt me-1"></i>Nome:</label>
                    <input type="text" id="new-bairro-name" class="form-control form-control-sm" placeholder="Ex: ALDEOTA">
                </div>
                
                <div class="new-item-row">
                    <label><i class="fas fa-users me-1"></i>Visitantes:</label>
                    <input type="number" id="new-bairro-visitas" class="form-control form-control-sm" placeholder="0" min="0" value="0">
                </div>
                
                <div class="new-item-actions">
                    <button class="btn btn-success btn-sm" onclick="addNewBairro()">
                        <i class="fas fa-save me-1"></i> Salvar Bairro
                    </button>
                </div>
                
                <small class="text-muted d-block mt-2" style="font-size: 10px;">
                    <i class="fas fa-info-circle me-1"></i> Bairros adicionados manualmente. IDH deve ser cadastrado na aba específica.
                </small>
            </div>
        </div>

        <div class="tab-pane fade" id="idh-pane">
            <div class="alert-warning-custom" id="idh-warning">
                <i class="fas fa-exclamation-triangle me-1"></i> Bairros sem IDH detectados!
            </div>
            <div id="idh-edit-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;"></div>
            
            <div class="new-item-container">
                <div class="new-item-title">
                    <i class="fas fa-chart-line me-2"></i>Adicionar/Editar IDH de Bairro
                </div>
                
                <div class="new-item-row">
                    <label><i class="fas fa-map-marker-alt me-1"></i>Bairro:</label>
                    <select id="idh-bairro-select" class="form-select form-select-sm">
                        <option value="">Selecione um bairro...</option>
                    </select>
                </div>
                
                <div class="new-item-row">
                    <label><i class="fas fa-chart-line me-1"></i>IDH (0-1):</label>
                    <input type="number" id="new-idh-value" class="form-control form-control-sm" placeholder="Ex: 0.850" step="0.001" min="0" max="1">
                </div>
                
                <div class="new-item-actions">
                    <button class="btn btn-primary btn-sm" onclick="addOrUpdateIDH()">
                        <i class="fas fa-save me-1"></i> Salvar IDH
                    </button>
                </div>
                
                <small class="text-muted d-block mt-2" style="font-size: 10px;">
                    <i class="fas fa-info-circle me-1"></i> O IDH deve estar entre 0 e 1. Disponível apenas para bairros de Fortaleza.
                </small>
            </div>
        </div>
        
        <div class="tab-pane fade" id="pos-pane">
            <div id="coords-list" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 10px;"></div>
        </div>

        <div class="tab-pane fade" id="style-pane">
            <div class="theme-selector mb-3">
                <label class="form-label text-white">Tema Visual</label>
                <select class="form-select form-select-sm" id="themeSelector" onchange="changeTheme(this.value)">
                    <option value="classic" selected>Tema Clássico (Réplica Antiga)</option>
                    <option value="modern">Tema Moderno</option>
                </select>
                <small class="text-white-50 d-block mt-1">Escolha o visual do mapa e rótulos</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label d-flex justify-content-between">Tamanho da Fonte <span id="fontSizeVal">12px</span></label>
                <input type="range" class="form-range" id="fontSizeRange" min="8" max="24" value="12" oninput="updateStyle('size', this.value)">
            </div>
            
            <div class="balloon-size-control mb-3">
                <label class="form-label d-flex justify-content-between">Tamanho do Balão (padding) <span id="balloonSizeVal">4px 8px</span></label>
                <div class="d-flex gap-2 align-items-center">
                    <span style="font-size:10px;">Menor</span>
                    <input type="range" class="form-range" id="balloonSizeRange" min="2" max="12" value="4" oninput="updateBalloonPadding(this.value)">
                    <span style="font-size:10px;">Maior</span>
                </div>
                <div class="d-flex gap-2 mt-2">
                    <select class="form-select form-select-sm" id="balloonPresetSelect" style="width: auto;" onchange="applyBalloonPreset(this.value)">
                        <option value="">Presets</option>
                        <option value="small">Compacto (2px 4px)</option>
                        <option value="medium">Padrão (4px 8px)</option>
                        <option value="large">Confortável (6px 12px)</option>
                        <option value="xlarge">Grande (8px 16px)</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" onclick="applyBalloonPreset('medium')">Reset</button>
                </div>
                <small class="text-muted d-block mt-1">Ajusta o espaçamento interno dos balões</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Peso da Fonte</label>
                <select class="form-select form-select-sm" id="fontWeightSelect" onchange="updateStyle('weight', this.value)">
                    <option value="normal">Normal</option>
                    <option value="bold" selected>Negrito</option>
                    <option value="800">Extra Negrito</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Cor do Texto</label>
                <input type="color" class="form-control form-control-sm" id="fontColorInput" value="#333333" onchange="updateStyle('color', this.value)">
            </div>
            <div class="mb-3" id="selection-box-option" style="display:none;">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="toggleSelectionBox" onchange="updateStyle('selectionBox', this.checked)">
                    <label class="form-check-label" for="toggleSelectionBox" style="font-size: 12px; font-weight: 600; color: #333;">Quadro de Seleção (Fortaleza)</label>
                </div>
                <small class="text-muted" style="font-size: 10px;">Habilita a seleção múltipla de bairros.</small>
            </div>
            <hr>
            <div class="mb-3">
                <label class="form-label">Título do Sistema</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="systemTitleInput" class="form-control" placeholder="Novo título...">
                    <button class="btn btn-primary" onclick="updateSystemTitle()">Alterar</button>
                </div>
            </div>
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="toggleAutoCalculate" checked onchange="toggleAutoCalculate(this.checked)">
                    <label class="form-check-label" for="toggleAutoCalculate" style="font-size: 12px; font-weight: 600; color: #333;">Calcular totais automaticamente</label>
                </div>
            </div>
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="toggleAutoBackup" checked onchange="toggleAutoBackup(this.checked)">
                    <label class="form-check-label" for="toggleAutoBackup" style="font-size: 12px; font-weight: 600; color: #333;">Backup automático antes de importar</label>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="analysis-pane">
            <div class="feature-toggle">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="featureStatisticalAnalysis" onchange="toggleStatisticalFeature(this.checked)">
                    <label class="form-check-label text-white" for="featureStatisticalAnalysis">
                        <i class="fas fa-chart-line me-1"></i> Habilitar Análise Estatística no Painel Principal
                    </label>
                </div>
                <small class="d-block text-white-50 mt-1">Quando desabilitado, o painel de estatísticas fica oculto.</small>
            </div>

            <div class="feature-toggle mt-2" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%);">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="featurePresentationMode" onchange="togglePresentationFeature(this.checked)">
                    <label class="form-check-label text-white" for="featurePresentationMode">
                        <i class="fas fa-desktop me-1"></i> Habilitar Modo Apresentação
                    </label>
                </div>
                <small class="d-block text-white-50 mt-1">Quando habilitado, o botão de apresentação aparecerá no canto inferior esquerdo.</small>
            </div>

            <div class="statistical-analysis" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                <div class="statistical-header">
                    <i class="fas fa-chart-line"></i>
                    <span>Análise Avançada</span>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-white">Tipo de Análise</label>
                    <select class="form-select form-select-sm" id="analysis-type" onchange="runAdvancedAnalysis()">
                        <option value="distribution">Distribuição</option>
                        <option value="correlation">Correlação (Visitas x IDH)</option>
                        <option value="quartile">Ranking por Quartis</option>
                    </select>
                </div>
                
                <div id="analysis-results" class="bg-white p-2 rounded" style="min-height: 200px; color: #333; font-size: 12px;">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-bar fa-2x mb-2"></i>
                        <div>Selecione um tipo de análise para começar</div>
                    </div>
                </div>
                
                <div class="mt-2">
                    <button class="btn btn-sm btn-light w-100" onclick="exportAnalysisReport()">
                        <i class="fas fa-file-pdf me-1"></i> Exportar Relatório
                    </button>
                </div>
            </div>
            
            <div class="version-history mt-3">
                <div class="version-header" onclick="toggleVersionHistory()">
                    <span><i class="fas fa-history me-2"></i>Histórico de Versões</span>
                    <i class="fas fa-chevron-down" id="version-chevron"></i>
                </div>
                <div class="version-list" id="version-list"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="io-pane">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Sistema de Importação Profissional</strong><br>
                Formatos aceitos: JSON, CSV, TSV. Backup automático antes de cada importação.
            </div>

            <div class="file-upload-container">
                <div class="file-upload-header">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Upload de Arquivo</span>
                </div>
                <div class="file-input-wrapper">
                    <div class="file-input-button">
                        <i class="fas fa-folder-open"></i> Escolher Arquivo JSON/CSV
                    </div>
                    <input type="file" id="jsonFileInput" accept=".json,.csv,.tsv,application/json,text/csv" onchange="handleProfessionalFileUpload(this.files)">
                </div>
                <div class="selected-file-info" id="selected-file-info">
                    <i class="fas fa-file-code me-1"></i> <span id="selected-file-name"></span>
                    <button class="btn btn-sm btn-light ms-2" onclick="clearSelectedFile()"><i class="fas fa-times"></i></button>
                </div>
                <div class="mt-2">
                    <small><i class="fas fa-info-circle me-1"></i> Máx. 10MB - JSON, CSV ou TSV</small>
                </div>
            </div>

            <div class="import-auto-panel">
                <div class="import-auto-header">
                    <i class="fas fa-file-import"></i>
                    <h6>Importação Manual de Dados</h6>
                </div>
                <div class="import-auto-description">
                    Cole dados no formato desejado (JSON, CSV, TSV) para importação.
                </div>
                <textarea id="autoImportArea" class="form-control form-control-sm mb-2" rows="4" placeholder='Ex: 
{
  "brasil": {
    "visitas": {
      "CE": 45668,
      "RN": 164,
      "SP": 107,
      "PE": 77
    }
  }
}

ou

Nome,Visitas,IDH
SÃO PAULO,1500
RIO DE JANEIRO,850
MINAS GERAIS,1200,0.731'></textarea>
                <div class="d-flex gap-2 mb-2">
                    <select id="importLevelSelect" class="form-select form-select-sm" style="width: auto;">
                        <option value="brasil">Brasil (Estados)</option>
                        <option value="ceara">Ceará (Municípios)</option>
                        <option value="fortaleza">Fortaleza (Bairros)</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="analyzeAndImportProfessional()">
                        <i class="fas fa-search me-1"></i> Analisar e Importar
                    </button>
                </div>
                <div class="progress-import" id="importProgress">
                    <div class="progress-import-bar" id="importProgressBar"></div>
                </div>
                <div id="importPreview" class="import-preview">
                    <small class="text-muted">Pré-visualização:</small>
                    <div id="importPreviewItems"></div>
                </div>
                <div class="duplicate-resolution" id="duplicateResolution" style="display:none;">
                    <strong><i class="fas fa-exclamation-triangle me-1"></i>Duplicatas detectadas</strong>
                    <div class="import-radio-group mt-2">
                        <label><input type="radio" name="duplicateAction" value="replace" checked> Substituir existentes</label>
                        <label><input type="radio" name="duplicateAction" value="keep"> Manter existentes</label>
                        <label><input type="radio" name="duplicateAction" value="merge"> Somar valores</label>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">Formatos aceitos: JSON, CSV (vírgula, ponto e vírgula ou tab)</small>
                    <button class="btn btn-sm btn-link" onclick="clearImportArea()">Limpar</button>
                </div>
            </div>

            <div class="data-version-history" id="dataVersionHistory">
                <i class="fas fa-history me-1"></i> Última importação: <span id="lastImportTimestamp">Nunca</span>
                <button class="btn btn-sm btn-link p-0 ms-2" onclick="restoreLastBackup()">Restaurar</button>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="exportProfessionalPackage()">
                    <i class="fas fa-download me-1"></i> Exportar Pacote Completo
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="exportConfigProfessional()">
                    <i class="fas fa-archive me-1"></i> Exportar Configuração (Formato Padrão)
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="copyConfig()">
                    <i class="fas fa-copy me-1"></i> Copiar para Área de Transferência
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="exportAnalysisReport()">
                    <i class="fas fa-file-excel me-1"></i> Exportar Relatório de Análise
                </button>
                <hr>
                <!-- NOVO BOTÃO: Gerar e copiar pacote de configuração inicial -->
                <button class="btn btn-outline-info btn-sm" onclick="generateInitialDataPackage()">
                    <i class="fas fa-clipboard-list me-1"></i> 📋 Copiar Configuração Inicial
                </button>
            </div>
            <hr>
            <div class="mb-3">
                <label class="form-label">Importar Configurações (JSON)</label>
                <textarea id="importArea" class="form-control form-control-sm mb-2" rows="3" placeholder="Cole o JSON de configuração completo aqui..."></textarea>
                <button class="btn btn-success btn-sm w-100 mb-3" onclick="importConfigProfessional()">
                    <i class="fas fa-upload me-1"></i> Aplicar Configuração Completa
                </button>
                
                <label class="form-label">Importar GeoJSON Personalizado</label>
                <textarea id="geoJsonImportArea" class="form-control form-control-sm mb-2" rows="3" placeholder="Cole o GeoJSON aqui..."></textarea>
                <button class="btn btn-warning btn-sm w-100 text-white" onclick="importGeoJSON()">
                    <i class="fas fa-map-marked-alt me-1"></i> Aplicar Novo GeoJSON
                </button>
            </div>
        </div>
    </div>
    
    <div class="mt-3 pt-3 border-top d-flex justify-content-between flex-wrap gap-2">
        <button class="btn btn-info btn-sm text-white" onclick="takePerfectPrint()">
            <i class="fas fa-camera me-1"></i> Print Perfeito
        </button>
        <button class="btn btn-secondary btn-sm" onclick="fitMap()">
            <i class="fas fa-expand me-1"></i> Ajustar Zoom
        </button>
        <button class="btn btn-danger btn-sm" onclick="resetPositions()">Resetar</button>
        <button class="btn btn-primary btn-sm" onclick="saveAll()">Salvar</button>
    </div>
</div>

<div class="import-confirm-modal" id="importConfirmModal">
    <div class="import-confirm-content">
        <h5 class="mb-3"><i class="fas fa-file-import me-2"></i>Confirmar Importação</h5>
        <div id="importSummary"></div>
        <div class="import-options">
            <strong>Opções de importação:</strong>
            <div class="import-radio-group">
                <label><input type="radio" name="importMode" value="append" checked> Adicionar aos existentes</label>
                <label><input type="radio" name="importMode" value="replace"> Substituir todos</label>
            </div>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" onclick="closeImportModal()">Cancelar</button>
            <button class="btn btn-success" onclick="executeProfessionalImport()">Confirmar Importação</button>
        </div>
    </div>
</div>

<div class="import-confirm-modal" id="jsonViewModal" style="z-index: 9998;">
    <div class="import-confirm-content" style="max-width: 800px;">
        <h5 class="mb-3"><i class="fas fa-file-code me-2"></i>Visualização do Arquivo</h5>
        <div class="mb-3">
            <div class="btn-group btn-group-sm mb-2">
                <button class="btn btn-outline-primary" onclick="switchJsonView('formatted')">Formatado</button>
                <button class="btn btn-outline-primary" onclick="switchJsonView('raw')">Raw</button>
                <button class="btn btn-outline-primary" onclick="switchJsonView('stats')">Estatísticas</button>
            </div>
            <div id="jsonViewContent" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 11px;"></div>
        </div>
        <div class="d-flex justify-content-between">
            <div>
                <button class="btn btn-sm btn-success" onclick="importFromViewer()">
                    <i class="fas fa-upload me-1"></i> Importar Este Arquivo
                </button>
                <button class="btn btn-sm btn-info" onclick="validateJsonFile()">
                    <i class="fas fa-check-circle me-1"></i> Validar
                </button>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="closeJsonView()">
                <i class="fas fa-times me-1"></i> Fechar
            </button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="saving-indicator" id="savingIndicator">
    <i class="fas fa-spinner fa-spin"></i> Salvando...
</div>

    <div id="map"></div>

    <button class="presentation-toggle-btn" id="presentationToggleBtn" onclick="togglePresentationMode()" title="Ativar Modo Apresentação">
        <i class="fas fa-desktop"></i>
    </button>

    <div class="presentation-controls" id="presControls" style="display: none;">
        <button class="btn-pres" onclick="switchLevel('brasil')"><i class="fas fa-globe-americas"></i> Brasil</button>
        <button class="btn-pres" onclick="switchLevel('ceara')"><i class="fas fa-map-marked-alt"></i> Ceará</button>
        <button class="btn-pres" onclick="switchLevel('fortaleza')"><i class="fas fa-city"></i> Fortaleza</button>
        <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
        <button class="btn-pres" id="btnTour" onclick="toggleAutoTour()"><i class="fas fa-play"></i> Tour Automático</button>
    </div>

    <div id="presCard" class="floating-card" style="display: none;">
        <div style="background: #ffeaa7; color: #d63031; padding: 4px 12px; border-radius: 50px; font-weight: 800; font-size: 11px; display: inline-block; margin-bottom: 10px;">ORGULHO DO CEARÁ</div>
        <h4 id="presTitle" style="margin: 0; color: #2d3436; font-weight: 800;">Destaques</h4>
        <p id="presSubtitle" style="font-size: 13px; color: #636e72; margin-bottom: 15px;">Resumo estatístico da região</p>
        
        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div>
                <small style="display: block; color: #b2bec3; font-weight: 700; text-transform: uppercase; font-size: 10px;">Visitas</small>
                <strong id="presVisitas" style="font-size: 22px; color: #0984e3;">0</strong>
            </div>
            <div id="presIdhContainer">
                <small style="display: block; color: #b2bec3; font-weight: 700; text-transform: uppercase; font-size: 10px;">IDH Médio</small>
                <strong id="presIdh" style="font-size: 22px; color: #00b894;">0.000</strong>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="presChart"></canvas>
        </div>
        <div class="tour-timer-bar" id="tourTimer"></div>
    </div>

<div class="map-footer">
    <span>Fonte: Sistema de agendamento Cidade Mais Infância &copy; <span id="footer-year">2026</span></span>
    <span class="footer-signature">Desenvolvido pela Supervisão de T.I. da CMI</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // ==================== CONSTANTES DO BANCO DE DADOS ====================
    const DB_NAME = 'CidadeMaisInfanciaDB';
    const DB_VERSION = 30; // Versão incrementada para garantir a atualização e evitar conflitos anteriores
    const STORE_NAME = 'configuracoes';
    
    // ==================== DADOS INICIAIS - SERÃO POPULADOS PELO ADMIN ====================
    // ATENÇÃO ADMIN: Para fixar sua configuração, configure tudo no sistema,
    // depois clique em "📋 Copiar Configuração Inicial" na aba Importar/Exportar
    // e cole o resultado AQUI, substituindo o objeto vazio abaixo.
    const INITIAL_DATA = {
        visitasEstados: {},
        manualCoords: {},
        visitasMunicipios: {},
        manualCoordsMunicipios: {},
        visitasBairros: {},
        manualCoordsBairros: {},
        dadosIDHBairros: {},
        customBairrosData: { type: "FeatureCollection", features: [] },
        estadosMetadata: {},
        style: { size: 12, weight: 'bold', color: '#333333', title: 'Cidade Mais Infância', selectionBox: false, balloonPadding: '4px 8px' },
        labelSettings: { showNameLabelsBrasil: false, showNameLabelsCeara: false, showNameLabelsFortaleza: false, showNumberLabelsBrasil: true, showNumberLabelsCeara: true, showNumberLabelsFortaleza: true },
        autoCalculate: true,
        autoBackup: true,
        advancedStats: true,
        importHistory: [],
        lastValidConfig: null,
        importMetadata: {
            lastImportTimestamp: null,
            importCount: 0,
            totalImportedItems: 0
        },
        versionHistory: [],
        analysisCache: {},
        featureToggles: {
            statisticalAnalysis: false,
            presentationMode: false
        },
        theme: 'classic'
    };

    // ==================== VARIÁVEIS GLOBAIS ====================
    let visitasEstados = {}, manualCoords = {}, visitasMunicipios = {}, manualCoordsMunicipios = {}, 
        visitasBairros = {}, manualCoordsBairros = {}, dadosIDHBairros = {}, customBairrosData = { type: "FeatureCollection", features: [] }, 
        estadosMetadata = {}, importMetadata = { lastImportTimestamp: null, importCount: 0, totalImportedItems: 0 },
        _versionHistory = [], analysisCache = {}, featureToggles = { statisticalAnalysis: false, presentationMode: false },
        currentTheme = 'classic';
    
    // Getter/Setter para versionHistory para garantir que seja sempre um array
    Object.defineProperty(window, 'versionHistory', {
        get: function() { return Array.isArray(_versionHistory) ? _versionHistory : []; },
        set: function(val) { _versionHistory = Array.isArray(val) ? val : []; },
        configurable: true
    });
    
    let currentLevel = 'brasil', adminLevel = 'brasil', currentDetailItem = null, currentViewMode = 'visitas';
    let isPresentationMode = false;
    let tourInterval = null;
    let presChartInstance = null;
    let showNameLabelsBrasil = false, showNameLabelsCeara = false, showNameLabelsFortaleza = false;
    let showNumberLabelsBrasil = true, showNumberLabelsCeara = true, showNumberLabelsFortaleza = true;
    let showSelectionBoxFortaleza = false, selectedItems = new Set();
    let labelFontSize = 12, labelFontWeight = 'bold', labelFontColor = '#333333', systemTitle = 'Cidade Mais Infância', 
        balloonPadding = '4px 8px', activeFilter = null, autoCalculate = true, autoBackup = true, advancedStats = true;
    
    let pendingImportData = null;
    let importHistory = [];
    let lastValidConfig = null;
    let currentJsonFile = null;
    let jsonViewMode = 'formatted';
    let chartInstance = null;
    
    let dadosIDHBairrosPorNomeNorm = {};
    let cearaData, fortalezaData, statesData;
    let customBairrosLayer;
    let dbInitialized = false;
    let db = null;
    
    const map = L.map('map', { zoomControl: false, closePopupOnClick: false }).setView([-15, -55], 4);
    L.control.zoom({ position: 'bottomleft' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);
    
    let geojsonLayer;
    const labelsLayer = L.layerGroup().addTo(map);
    let drawnItems = new L.FeatureGroup();

    const descricoesBairros = { "default": "Informação técnica em processamento para esta localidade." };

    // ==================== FUNÇÃO DE LOG ====================
    function silentLog(message, type = 'info') {
        console.log(`[${type}] ${message}`);
    }

    // ==================== FUNÇÕES DE TEMA ====================
    function changeTheme(theme) {
        currentTheme = theme;
        const body = document.body;
        body.classList.remove('theme-modern', 'theme-classic');
        body.classList.add(`theme-${theme}`);
        
        const selector = document.getElementById('themeSelector');
        if (selector) selector.value = theme;
        
        renderLabels();
        saveToDatabase();
        silentLog(`Tema alterado para ${theme}`, 'success');
    }

    function getClassicColor(d) {
        return d > 1000 ? '#08306b' : 
               d > 500  ? '#084594' : 
               d > 100  ? '#2171b5' : 
               d > 50   ? '#4292c6' : 
               d > 20   ? '#6baed6' : 
               d > 0    ? '#9ecae1' : '#eff3ff';
    }

    function getModernColor(d) {
        return d > 1000 ? '#08306b' : 
               d > 500  ? '#084594' : 
               d > 100  ? '#2171b5' : 
               d > 50   ? '#4292c6' : 
               d > 20   ? '#6baed6' : 
               d > 0    ? '#9ecae1' : '#eff3ff';
    }

    function getStateColor(d) {
        if (currentTheme === 'classic') {
            return getClassicColor(d);
        } else {
            return getModernColor(d);
        }
    }
    
    // ==================== FUNÇÃO PARA AJUSTAR O PADDING DO BALÃO ====================
    function updateBalloonPadding(value) {
        const basePadding = parseInt(value) || 4;
        balloonPadding = `${basePadding}px ${Math.round(basePadding * 2)}px`;
        document.getElementById('balloonSizeVal').textContent = balloonPadding;
        document.documentElement.style.setProperty('--label-padding', balloonPadding);
        const labels = document.querySelectorAll('.state-label');
        labels.forEach(l => l.style.padding = balloonPadding);
        saveToDatabase();
        silentLog(`Padding do balão atualizado: ${balloonPadding}`);
    }
    
    function applyBalloonPreset(preset) {
        let value = 4;
        if (preset === 'small') value = 2;
        else if (preset === 'medium') value = 4;
        else if (preset === 'large') value = 6;
        else if (preset === 'xlarge') value = 8;
        
        document.getElementById('balloonSizeRange').value = value;
        updateBalloonPadding(value);
    }
    
    // ==================== FUNÇÕES DE BANCO DE DADOS ====================

    // ==================== CONFIGURAÇÃO DO SUPABASE ====================
    const supabaseUrl = 'https://jkamgpeiqouoepugrfzw.supabase.co';
    const supabaseKey = 'sb_publishable_9UDSUIkrkCCEBwgUSEb0LA_eYZPmlu2';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Função para salvar dados globalmente no Supabase
    async function saveToDatabase() {
        showSavingIndicator(true);
        
        const fullConfig = {
            visitasEstados,
            manualCoords,
            visitasMunicipios,
            manualCoordsMunicipios,
            visitasBairros,
            manualCoordsBairros,
            dadosIDHBairros,
            customBairrosData,
            estadosMetadata,
            style: { 
                size: labelFontSize, 
                weight: labelFontWeight, 
                color: labelFontColor, 
                title: systemTitle, 
                selectionBox: showSelectionBoxFortaleza, 
                balloonPadding: balloonPadding 
            },
            labelSettings: { 
                showNameLabelsBrasil, 
                showNameLabelsCeara, 
                showNameLabelsFortaleza, 
                showNumberLabelsBrasil, 
                showNumberLabelsCeara, 
                showNumberLabelsFortaleza 
            },
            autoCalculate,
            autoBackup,
            advancedStats,
            importHistory,
            importMetadata,
            versionHistory,
            analysisCache,
            featureToggles,
            theme: currentTheme,
            timestamp: new Date().toISOString()
        };

        try {
            const { error } = await _supabase
                .from('app_config')
                .upsert({ id: 'main_config', data: fullConfig });

            if (error) {
                console.error('Erro ao salvar no Supabase:', error);
                showToast('Erro ao salvar globalmente', 'error');
            } else {
                silentLog('Dados salvos globalmente no Supabase!', 'success');
            }
        } catch (e) {
            console.error('Exceção ao salvar no Supabase:', e);
        } finally {
            showSavingIndicator(false);
        }
    }

    // Função para carregar dados globalmente do Supabase
    async function loadFromDatabase() {
        silentLog('Iniciando carregamento global do Supabase...');
        try {
            const { data, error } = await _supabase
                .from('app_config')
                .select('data')
                .eq('id', 'main_config')
                .single();

            if (error) {
                if (error.code === 'PGRST116') {
                    silentLog('Nenhum dado global encontrado. Usando dados iniciais.', 'warning');
                    // Inicializar com dados locais se o banco estiver vazio
                    restoreFromBackup(INITIAL_DATA);
                } else {
                    console.error('Erro ao carregar do Supabase:', error);
                    showToast('Erro ao carregar dados globais', 'error');
                }
                return;
            }

            if (data && data.data) {
                const config = data.data;
                
                // Atribuição das variáveis globais
                visitasEstados = config.visitasEstados || {};
                manualCoords = config.manualCoords || {};
                visitasMunicipios = config.visitasMunicipios || {};
                manualCoordsMunicipios = config.manualCoordsMunicipios || {};
                visitasBairros = config.visitasBairros || {};
                manualCoordsBairros = config.manualCoordsBairros || {};
                dadosIDHBairros = config.dadosIDHBairros || {};
                customBairrosData = config.customBairrosData || { type: "FeatureCollection", features: [] };
                estadosMetadata = config.estadosMetadata || {};
                
                if (config.style) {
                    labelFontSize = config.style.size || 12;
                    labelFontWeight = config.style.weight || 'bold';
                    labelFontColor = config.style.color || '#333333';
                    systemTitle = config.style.title || 'Cidade Mais Infância';
                    showSelectionBoxFortaleza = config.style.selectionBox || false;
                    balloonPadding = config.style.balloonPadding || '4px 8px';
                }
                
                if (config.labelSettings) {
                    showNameLabelsBrasil = config.labelSettings.showNameLabelsBrasil || false;
                    showNameLabelsCeara = config.labelSettings.showNameLabelsCeara || false;
                    showNameLabelsFortaleza = config.labelSettings.showNameLabelsFortaleza || false;
                    showNumberLabelsBrasil = config.labelSettings.showNumberLabelsBrasil !== undefined ? config.labelSettings.showNumberLabelsBrasil : true;
                    showNumberLabelsCeara = config.labelSettings.showNumberLabelsCeara !== undefined ? config.labelSettings.showNumberLabelsCeara : true;
                    showNumberLabelsFortaleza = config.labelSettings.showNumberLabelsFortaleza !== undefined ? config.labelSettings.showNumberLabelsFortaleza : true;
                }
                
                autoCalculate = config.autoCalculate !== undefined ? config.autoCalculate : true;
                autoBackup = config.autoBackup !== undefined ? config.autoBackup : true;
                advancedStats = config.advancedStats !== undefined ? config.advancedStats : true;
                importHistory = config.importHistory || [];
                importMetadata = config.importMetadata || { lastImportTimestamp: null, importCount: 0, totalImportedItems: 0 };
                versionHistory = config.versionHistory || [];
                analysisCache = config.analysisCache || {};
                featureToggles = config.featureToggles || { statisticalAnalysis: false, presentationMode: false };
                currentTheme = config.theme || 'classic';

                silentLog('Dados globais carregados com sucesso!', 'success');
            }
        } catch (e) {
            console.error('Exceção ao carregar do Supabase:', e);
        }
    }
    // ==================== FEATURE TOGGLES ====================
    function toggleStatisticalFeature(enabled) {
        featureToggles.statisticalAnalysis = enabled;
        const panel = document.getElementById('statistical-analysis-panel');
        if (panel) {
            if (enabled) {
                panel.classList.add('visible');
                panel.style.display = 'block';
                updateStatisticalAnalysis();
                updateRanking();
            } else {
                panel.classList.remove('visible');
                panel.style.display = 'none';
            }
        }
        saveToDatabase();
        silentLog(`Análise estatística ${enabled ? 'ativada' : 'desativada'}`, 'info');
    }

    function togglePresentationFeature(enabled) {
        featureToggles.presentationMode = enabled;
        const presentationBtn = document.getElementById('presentationToggleBtn');
        
        if (enabled) {
            presentationBtn.classList.add('visible');
            presentationBtn.style.display = 'flex';
        } else {
            presentationBtn.classList.remove('visible');
            presentationBtn.style.display = 'none';
            if (isPresentationMode) {
                togglePresentationMode();
            }
        }
        
        saveToDatabase();
        silentLog(`Modo apresentação ${enabled ? 'habilitado' : 'desabilitado'}`, 'info');
    }

    // ==================== FUNÇÕES DE BACKUP ====================
    function createBackup() {
        return {
            visitasEstados: JSON.parse(JSON.stringify(visitasEstados)),
            manualCoords: JSON.parse(JSON.stringify(manualCoords)),
            visitasMunicipios: JSON.parse(JSON.stringify(visitasMunicipios)),
            manualCoordsMunicipios: JSON.parse(JSON.stringify(manualCoordsMunicipios)),
            visitasBairros: JSON.parse(JSON.stringify(visitasBairros)),
            manualCoordsBairros: JSON.parse(JSON.stringify(manualCoordsBairros)),
            dadosIDHBairros: JSON.parse(JSON.stringify(dadosIDHBairros)),
            estadosMetadata: JSON.parse(JSON.stringify(estadosMetadata)),
            importMetadata: JSON.parse(JSON.stringify(importMetadata)),
            featureToggles: JSON.parse(JSON.stringify(featureToggles)),
            theme: currentTheme,
            timestamp: new Date().toISOString()
        };
    }

    function restoreFromBackup(backup) {
        if (backup.visitasEstados) visitasEstados = backup.visitasEstados;
        if (backup.manualCoords) manualCoords = backup.manualCoords;
        if (backup.visitasMunicipios) visitasMunicipios = backup.visitasMunicipios;
        if (backup.manualCoordsMunicipios) manualCoordsMunicipios = backup.manualCoordsMunicipios;
        if (backup.visitasBairros) visitasBairros = backup.visitasBairros;
        if (backup.manualCoordsBairros) manualCoordsBairros = backup.manualCoordsBairros;
        if (backup.dadosIDHBairros) dadosIDHBairros = backup.dadosIDHBairros;
        if (backup.estadosMetadata) estadosMetadata = backup.estadosMetadata;
        if (backup.importMetadata) importMetadata = backup.importMetadata;
        if (backup.featureToggles) featureToggles = backup.featureToggles;
        if (backup.theme) {
            currentTheme = backup.theme;
            changeTheme(currentTheme);
        }
        
        rebuildIDHIndex();
        calculateSums();
        updateMap();
        updateStatisticalAnalysis();
        updateRanking();
        
        if (document.getElementById('featureStatisticalAnalysis')) {
            document.getElementById('featureStatisticalAnalysis').checked = featureToggles.statisticalAnalysis;
        }
        toggleStatisticalFeature(featureToggles.statisticalAnalysis);
        
        if (document.getElementById('featurePresentationMode')) {
            document.getElementById('featurePresentationMode').checked = featureToggles.presentationMode;
        }
        togglePresentationFeature(featureToggles.presentationMode);
        
        silentLog("Backup restaurado com sucesso!", "success");
    }

    function restoreLastBackup() {
        if (lastValidConfig) {
            restoreFromBackup(lastValidConfig);
            saveToDatabase();
        } else {
            silentLog("Nenhum backup disponível", "warning");
        }
    }

    function addToVersionHistory(action, description) {
        versionHistory.push({
            timestamp: new Date().toISOString(),
            action: action,
            description: description,
            dataSnapshot: createBackup()
        });
        
        if (versionHistory.length > 20) {
            versionHistory.shift();
        }
        
        updateVersionHistoryDisplay();
        saveToDatabase();
    }

    function updateVersionHistoryDisplay() {
        const list = document.getElementById('version-list'); 
        if (!list) return; 
        
        if (!Array.isArray(versionHistory) || versionHistory.length === 0) {
            versionHistory = Array.isArray(versionHistory) ? versionHistory : [];
            list.innerHTML = '<div class="text-center text-muted p-3">Nenhum histórico disponível</div>';
            return;
        }
        
        list.innerHTML = '';
        versionHistory.slice().reverse().forEach((item, index) => {
            const date = new Date(item.timestamp);
            const formattedDate = date.toLocaleString('pt-BR');
            
            const div = document.createElement('div');
            div.className = 'version-item';
            div.innerHTML = `
                <div>
                    <strong>${item.action}</strong><br>
                    <small class="text-muted">${formattedDate}</small>
                </div>
                <div class="version-actions">
                    <button class="btn btn-xs btn-outline-primary" onclick="restoreVersion(${versionHistory.length - 1 - index})">Restaurar</button>
                    <button class="btn btn-xs btn-outline-info" onclick="viewVersion(${versionHistory.length - 1 - index})">Visualizar</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function toggleVersionHistory() {
        const list = document.getElementById('version-list');
        const chevron = document.getElementById('version-chevron');
        
        if (list.style.display === 'none' || list.style.display === '') {
            list.style.display = 'block';
            chevron.className = 'fas fa-chevron-up';
        } else {
            list.style.display = 'none';
            chevron.className = 'fas fa-chevron-down';
        }
    }

    function restoreVersion(index) {
        if (index >= 0 && index < versionHistory.length) {
            restoreFromBackup(versionHistory[index].dataSnapshot);
            silentLog(`Versão de ${new Date(versionHistory[index].timestamp).toLocaleString()} restaurada`, "success");
        }
    }

    function viewVersion(index) {
        if (index >= 0 && index < versionHistory.length) {
            const data = versionHistory[index].dataSnapshot;
            showJsonModal(data, `Visualização - ${new Date(versionHistory[index].timestamp).toLocaleString()}`);
        }
    }

    // ==================== FUNÇÃO FORÇAR OPERAÇÃO ====================
    function forceOperation() {
        if (confirm('FORÇAR OPERAÇÃO: Isso irá recalcular todos os totais e aplicar correções críticas. Continuar?')) {
            silentLog('Iniciando operação forçada...', 'warning');
            
            rebuildIDHIndex();
            calculateSums();
            ensureAllStateCoords();
            ensureAllMunicipioCoords();
            ensureAllBairroCoords();
            applySpecificCorrections();
            
            updateMap();
            updateStatisticalAnalysis();
            updateRanking();
            updateAdminList();
            updateIDHList();
            
            saveToDatabase().then(() => {
                silentLog('Operação forçada concluída com sucesso!', 'success');
                showToast('Operação forçada concluída! Todos os dados foram recalculados.', 'success');
            }).catch(error => {
                silentLog(`Erro na operação forçada: ${error}`, 'error');
                showToast('Erro na operação forçada. Verifique o console.', 'error');
            });
        }
    }
    
    // ==================== FUNÇÃO LIMPAR CACHE ====================
    function clearCacheAndReload() {
        if (confirm('🧹 LIMPAR CACHE: Isso irá limpar o cache do navegador para esta aplicação e recarregar a página. Todos os dados não salvos serão perdidos. Continuar?')) {
            silentLog('Iniciando limpeza de cache...', 'warning');
            
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => {
                        if (cacheName.includes('CidadeMaisInfancia') || cacheName.includes('leaflet') || cacheName.includes('geojson')) {
                            caches.delete(cacheName).then(() => {
                                silentLog(`Cache ${cacheName} removido`, 'success');
                            });
                        }
                    });
                });
            }
            
            showToast('Cache limpo! Recarregando página...', 'info');
            
            setTimeout(() => {
                window.location.reload(true);
            }, 1000);
        }
    }

    // ==================== FUNÇÕES DE UPLOAD DE ARQUIVO ====================
    function handleProfessionalFileUpload(files) {
        if (!files || files.length === 0) return;
        
        const file = files[0];
        
        if (file.size > 10 * 1024 * 1024) {
            silentLog('Arquivo muito grande. Máximo 10MB.', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                let data;
                
                if (file.name.toLowerCase().endsWith('.json')) {
                    data = JSON.parse(content);
                } else {
                    data = { type: 'tabular', content: content, filename: file.name };
                }
                
                currentJsonFile = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    data: data,
                    raw: content
                };
                
                document.getElementById('selected-file-name').textContent = `${file.name} (${(file.size/1024).toFixed(2)} KB)`;
                document.getElementById('selected-file-info').style.display = 'block';
                
                setTimeout(() => {
                    analyzeUploadedFile();
                }, 100);
                
            } catch (error) {
                silentLog('Erro ao ler arquivo: ' + error.message, 'error');
            }
        };
        
        if (file.name.toLowerCase().endsWith('.json')) {
            reader.readAsText(file);
        } else {
            reader.readAsText(file);
        }
    }

    function analyzeUploadedFile() {
        if (!currentJsonFile) return;
        
        try {
            const targetLevel = document.getElementById('importLevelSelect').value;
            
            if (currentJsonFile.name.toLowerCase().endsWith('.json')) {
                pendingImportData = parseJSONDataProfessional(currentJsonFile.data, targetLevel);
            } else {
                pendingImportData = parseCSVDataProfessional(currentJsonFile.raw, targetLevel);
            }
            
            if (!pendingImportData || pendingImportData.items.length === 0) {
                silentLog('Nenhum item válido encontrado para importação', 'warning');
                return;
            }
            
            pendingImportData.duplicates = detectDuplicatesProfessional(pendingImportData.items, targetLevel);
            
            updateImportPreviewProfessional(pendingImportData);
            
            if (pendingImportData.duplicates > 0) {
                document.getElementById('duplicateResolution').style.display = 'block';
            } else {
                document.getElementById('duplicateResolution').style.display = 'none';
            }
            
            showImportConfirmModal(pendingImportData);
            
        } catch (error) {
            silentLog('Erro na análise: ' + error.message, 'error');
        }
    }

    function parseJSONDataProfessional(data, targetLevel) {
        const items = [];
        const warnings = [];
        const errors = [];
        
        try {
            if (data.brasil && data.brasil.visitas && targetLevel === 'brasil') {
                Object.entries(data.brasil.visitas).forEach(([key, value]) => {
                    items.push({
                        nome: key,
                        visitas: parseInt(value) || 0,
                        idh: null
                    });
                });
            }
            else if (data.ceara && data.ceara.visitas && targetLevel === 'ceara') {
                Object.entries(data.ceara.visitas).forEach(([key, value]) => {
                    items.push({
                        nome: key,
                        visitas: parseInt(value) || 0,
                        idh: null
                    });
                });
            }
            else if (data.fortaleza && data.fortaleza.visitas && targetLevel === 'fortaleza') {
                Object.entries(data.fortaleza.visitas).forEach(([key, value]) => {
                    items.push({
                        nome: key,
                        visitas: parseInt(value) || 0,
                        idh: data.fortaleza.idh && data.fortaleza.idh[key] ? data.fortaleza.idh[key] : null
                    });
                });
            }
            else if (Array.isArray(data)) {
                data.forEach((item, index) => {
                    const nome = item.nome || item.name || item.Nome || item.Name || item.estado || item.municipio || item.bairro;
                    const visitas = parseInt(item.visitas || item.Visitas || item.valor || item.Valor || item.quantidade || 0);
                    const idh = item.idh || item.IDH || null;
                    
                    if (nome) {
                        items.push({
                            nome: String(nome).trim(),
                            visitas: isNaN(visitas) ? 0 : visitas,
                            idh: idh ? parseFloat(idh) : null
                        });
                    } else {
                        errors.push(`Item ${index + 1}: Nome não encontrado`);
                    }
                });
            }
            else if (typeof data === 'object') {
                Object.entries(data).forEach(([key, value]) => {
                    if (typeof value === 'number' || (typeof value === 'string' && !isNaN(parseInt(value)))) {
                        items.push({
                            nome: key,
                            visitas: parseInt(value) || 0,
                            idh: null
                        });
                    }
                });
            }
            
        } catch (e) {
            errors.push(`Erro no parse JSON: ${e.message}`);
        }
        
        return {
            items,
            warnings,
            errors,
            total: items.length,
            valid: items.length,
            targetLevel
        };
    }

    function parseCSVDataProfessional(text, targetLevel) {
        const lines = text.split('\n').filter(line => line.trim());
        const items = [];
        const warnings = [];
        const errors = [];

        if (lines.length === 0) {
            return { items, warnings, errors, total: 0, valid: 0, targetLevel };
        }

        const firstLine = lines[0];
        let separator = ',';
        if (firstLine.includes(';')) separator = ';';
        else if (firstLine.includes('\t')) separator = '\t';

        const headers = firstLine.split(separator).map(h => h.trim().toLowerCase().replace(/^["']|["']$/g, ''));
        const hasHeader = headers.some(h => 
            h.includes('nome') || h.includes('name') || h.includes('estado') || 
            h.includes('municipio') || h.includes('bairro') || h.includes('uf')
        );
        
        const startIndex = hasHeader ? 1 : 0;

        for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const parts = line.split(separator).map(p => p.trim().replace(/^["']|["']$/g, ''));
            
            if (parts.length >= 1) {
                try {
                    const nome = parts[0];
                    const visitas = parts[1] ? parseInt(parts[1].replace(/[^\d-]/g, '')) || 0 : 0;
                    const idh = parts[2] ? parseFloat(parts[2].replace(',', '.')) : null;

                    if (!nome) {
                        errors.push(`Linha ${i + 1}: Nome vazio`);
                        continue;
                    }

                    items.push({
                        nome: nome,
                        visitas: isNaN(visitas) ? 0 : visitas,
                        idh: (idh !== null && !isNaN(idh) && idh >= 0 && idh <= 1) ? idh : null
                    });
                } catch (e) {
                    errors.push(`Linha ${i + 1}: Erro de parse - ${e.message}`);
                }
            }
        }

        return {
            items,
            warnings,
            errors,
            total: lines.length - startIndex,
            valid: items.length,
            targetLevel
        };
    }

    function detectDuplicatesProfessional(items, targetLevel) {
        let duplicateCount = 0;
        const existingKeys = new Set();
        
        if (targetLevel === 'brasil') {
            Object.keys(visitasEstados).forEach(k => existingKeys.add(k.toUpperCase()));
        } else if (targetLevel === 'ceara') {
            Object.keys(visitasMunicipios).forEach(k => existingKeys.add(k.toLowerCase()));
        } else if (targetLevel === 'fortaleza') {
            Object.keys(visitasBairros).forEach(k => existingKeys.add(normalizeBairroName(k)));
        }

        items.forEach(item => {
            let key;
            if (targetLevel === 'brasil') {
                key = item.nome.length <= 3 ? item.nome.toUpperCase() : findStateSiglaByName(item.nome) || item.nome.toUpperCase();
            } else if (targetLevel === 'ceara') {
                key = item.nome.toLowerCase();
            } else {
                key = normalizeBairroName(item.nome);
            }
            
            if (existingKeys.has(key)) {
                duplicateCount++;
            }
        });

        return duplicateCount;
    }

    function updateImportPreviewProfessional(data) {
        const previewDiv = document.getElementById('importPreviewItems');
        previewDiv.innerHTML = '';

        const statsDiv = document.createElement('div');
        statsDiv.className = 'mb-2 p-2 bg-light rounded small';
        statsDiv.innerHTML = `
            <div><strong>Total:</strong> ${data.total} itens</div>
            <div><strong>Válidos:</strong> ${data.valid} itens</div>
            ${data.duplicates ? `<div class="text-warning"><strong>Duplicatas:</strong> ${data.duplicates}</div>` : ''}
            ${data.errors.length ? `<div class="text-danger"><strong>Erros:</strong> ${data.errors.length}</div>` : ''}
        `;
        previewDiv.appendChild(statsDiv);

        data.items.slice(0, 10).forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'import-preview-item';
            let html = `<strong>${item.nome}</strong> - Visitas: ${item.visitas.toLocaleString()}`;
            if (item.idh !== null) html += `, IDH: ${item.idh.toFixed(3)}`;
            div.innerHTML = html;
            previewDiv.appendChild(div);
        });

        if (data.items.length > 10) {
            const div = document.createElement('div');
            div.className = 'import-preview-item text-muted';
            div.innerHTML = `... e mais ${data.items.length - 10} itens`;
            previewDiv.appendChild(div);
        }

        if (data.errors.length > 0) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mt-2 p-2 bg-danger text-white rounded small';
            errorDiv.innerHTML = `<strong>Erros encontrados:</strong><br>${data.errors.slice(0, 3).join('<br>')}`;
            if (data.errors.length > 3) errorDiv.innerHTML += `<br>... e mais ${data.errors.length - 3} erros`;
            previewDiv.appendChild(errorDiv);
        }
    }

    function analyzeAndImportProfessional() {
        const importText = document.getElementById('autoImportArea').value.trim();
        const targetLevel = document.getElementById('importLevelSelect').value;
        
        if (!importText) { 
            silentLog('Cole os dados para importação', 'warning'); 
            return; 
        }

        showProgress(true);
        
        setTimeout(() => {
            try {
                let parsedData = null;
                try { 
                    parsedData = JSON.parse(importText); 
                    silentLog("Dados detectados como JSON");
                } catch (e) {
                }

                if (parsedData) {
                    pendingImportData = parseJSONDataProfessional(parsedData, targetLevel);
                } else {
                    pendingImportData = parseCSVDataProfessional(importText, targetLevel);
                }

                if (!pendingImportData || pendingImportData.items.length === 0) {
                    silentLog('Nenhum item válido encontrado para importação', 'warning');
                    showProgress(false);
                    return;
                }

                pendingImportData.duplicates = detectDuplicatesProfessional(pendingImportData.items, targetLevel);
                
                updateImportPreviewProfessional(pendingImportData);
                
                if (pendingImportData.duplicates > 0) {
                    document.getElementById('duplicateResolution').style.display = 'block';
                } else {
                    document.getElementById('duplicateResolution').style.display = 'none';
                }

                showImportConfirmModal(pendingImportData);
                
            } catch (error) {
                silentLog('Erro na análise: ' + error.message, 'error');
            } finally {
                showProgress(false);
            }
        }, 100);
    }

    function showImportConfirmModal(data) {
        const modal = document.getElementById('importConfirmModal');
        const summary = document.getElementById('importSummary');
        
        let html = `
            <div class="mb-3">
                <div class="import-summary-item">
                    <span>Total de itens:</span>
                    <strong>${data.total}</strong>
                </div>
                <div class="import-summary-item">
                    <span>Itens válidos:</span>
                    <strong>${data.valid}</strong>
                </div>
                ${data.duplicates ? `
                <div class="import-summary-item warning">
                    <span>Duplicatas detectadas:</span>
                    <strong>${data.duplicates}</strong>
                </div>
                ` : ''}
                ${data.errors.length ? `
                <div class="import-summary-item error">
                    <span>Erros:</span>
                    <strong>${data.errors.length}</strong>
                </div>
                ` : ''}
            </div>
            <div class="mb-3">
                <strong>Nível de destino:</strong> 
                ${data.targetLevel === 'brasil' ? 'Brasil (Estados)' : 
                  data.targetLevel === 'ceara' ? 'Ceará (Municípios)' : 'Fortaleza (Bairros)'}
            </div>
        `;

        if (data.items.length > 0) {
            html += '<div class="mb-3"><strong>Preview (primeiros 5):</strong><div style="max-height:150px; overflow-y:auto;">';
            data.items.slice(0, 5).forEach(item => {
                html += `<div class="small p-1 border-bottom">${item.nome}: ${item.visitas} visitas${item.idh ? `, IDH ${item.idh}` : ''}</div>`;
            });
            if (data.items.length > 5) html += '<div class="small text-muted p-1">...</div>';
            html += '</div></div>';
        }

        summary.innerHTML = html;
        modal.style.display = 'flex';
    }

    function closeImportModal() {
        document.getElementById('importConfirmModal').style.display = 'none';
        pendingImportData = null;
    }

    function executeProfessionalImport() {
        if (!pendingImportData) {
            closeImportModal();
            return;
        }

        const importMode = document.querySelector('input[name="importMode"]:checked').value;
        const duplicateAction = document.querySelector('input[name="duplicateAction"]:checked')?.value || 'replace';
        
        if (autoBackup) {
            const backup = createBackup();
            importHistory.push({
                timestamp: new Date().toISOString(),
                itemsCount: pendingImportData.items.length,
                backup: backup
            });
            if (importHistory.length > 10) importHistory.shift();
        }

        importMetadata.lastImportTimestamp = new Date().toISOString();
        importMetadata.importCount++;
        importMetadata.totalImportedItems += pendingImportData.items.length;

        if (importMode === 'replace') {
            if (pendingImportData.targetLevel === 'brasil') {
                visitasEstados = {};
                manualCoords = {};
                estadosMetadata = {};
            } else if (pendingImportData.targetLevel === 'ceara') {
                visitasMunicipios = {};
                manualCoordsMunicipios = {};
            } else if (pendingImportData.targetLevel === 'fortaleza') {
                visitasBairros = {};
                manualCoordsBairros = {};
            }
        }

        let importedCount = 0;
        let updatedCount = 0;
        let skippedCount = 0;

        pendingImportData.items.forEach(item => {
            const targetLevel = pendingImportData.targetLevel;
            
            if (targetLevel === 'brasil') {
                const sigla = item.nome.length <= 3 ? 
                    item.nome.toUpperCase() : 
                    findStateSiglaByName(item.nome);
                
                if (sigla) {
                    const existing = visitasEstados[sigla];
                    
                    if (existing !== undefined) {
                        if (duplicateAction === 'replace') {
                            visitasEstados[sigla] = item.visitas;
                            updatedCount++;
                        } else if (duplicateAction === 'merge') {
                            visitasEstados[sigla] = (visitasEstados[sigla] || 0) + item.visitas;
                            updatedCount++;
                        } else {
                            skippedCount++;
                        }
                    } else {
                        visitasEstados[sigla] = item.visitas;
                        importedCount++;
                    }
                    
                    if (item.nome.length > 3) {
                        if (!estadosMetadata[sigla]) estadosMetadata[sigla] = {};
                        estadosMetadata[sigla].nome = item.nome;
                    }
                }
            } else if (targetLevel === 'ceara') {
                const nome = item.nome.trim();
                const existing = visitasMunicipios[nome];
                
                if (existing !== undefined) {
                    if (duplicateAction === 'replace') {
                        visitasMunicipios[nome] = item.visitas;
                        updatedCount++;
                    } else if (duplicateAction === 'merge') {
                        visitasMunicipios[nome] = (visitasMunicipios[nome] || 0) + item.visitas;
                        updatedCount++;
                    } else {
                        skippedCount++;
                    }
                } else {
                    visitasMunicipios[nome] = item.visitas;
                    importedCount++;
                }
            } else if (targetLevel === 'fortaleza') {
                const nome = item.nome.trim();
                const existing = visitasBairros[nome];
                
                if (existing !== undefined) {
                    if (duplicateAction === 'replace') {
                        visitasBairros[nome] = item.visitas;
                        updatedCount++;
                    } else if (duplicateAction === 'merge') {
                        visitasBairros[nome] = (visitasBairros[nome] || 0) + item.visitas;
                        updatedCount++;
                    } else {
                        skippedCount++;
                    }
                } else {
                    visitasBairros[nome] = item.visitas;
                    importedCount++;
                }
                
                if (item.idh !== null && item.idh >= 0 && item.idh <= 1) {
                    dadosIDHBairros[nome] = item.idh;
                }
            }
        });

        rebuildIDHIndex();
        calculateSums();
        
        applySpecificCorrections();
        
        updateAdminList();
        updateIDHList();
        updateMap();
        updateRanking();
        
        saveToDatabase().then(() => {
            silentLog(`Importação concluída! ${importedCount} novos, ${updatedCount} atualizados, ${skippedCount} ignorados.`, 'success');
            
            const lastImportSpan = document.getElementById('lastImportTimestamp');
            if (lastImportSpan) {
                lastImportSpan.textContent = new Date().toLocaleString('pt-BR');
            }
            
            if (importHistory.length > 0) {
                document.getElementById('dataVersionHistory').style.display = 'block';
            }
        });

        closeImportModal();
        document.getElementById('autoImportArea').value = '';
        document.getElementById('importPreview').innerHTML = '<small class="text-muted">Pré-visualização:</small><div id="importPreviewItems"></div>';
        document.getElementById('duplicateResolution').style.display = 'none';
        clearSelectedFile();
        addToVersionHistory('Importação', `${importedCount} novos, ${updatedCount} atualizados`);
    }

    function exportProfessionalPackage() {
        const fullPackage = {
            metadata: {
                exportDate: new Date().toISOString(),
                version: '3.0',
                systemTitle: systemTitle,
                levels: ['brasil', 'ceara', 'fortaleza'],
                totalItems: {
                    brasil: Object.keys(visitasEstados).length,
                    ceara: Object.keys(visitasMunicipios).length,
                    fortaleza: Object.keys(visitasBairros).length
                },
                theme: currentTheme
            },
            brasil: {
                visitas: visitasEstados,
                metadata: estadosMetadata,
                coords: manualCoords
            },
            ceara: {
                visitas: visitasMunicipios,
                coords: manualCoordsMunicipios
            },
            fortaleza: {
                visitas: visitasBairros,
                idh: dadosIDHBairros,
                coords: manualCoordsBairros
            },
            settings: {
                style: { size: labelFontSize, weight: labelFontWeight, color: labelFontColor, title: systemTitle, selectionBox: showSelectionBoxFortaleza, balloonPadding: balloonPadding },
                labelSettings: { showNameLabelsBrasil, showNameLabelsCeara, showNameLabelsFortaleza, showNumberLabelsBrasil, showNumberLabelsCeara, showNumberLabelsFortaleza },
                autoCalculate,
                autoBackup,
                featureToggles,
                theme: currentTheme
            }
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fullPackage, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = `pacote_completo_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        silentLog('Pacote completo exportado com sucesso!', "success");
    }

    function exportConfigProfessional() {
        const config = {
            visitasEstados,
            manualCoords,
            visitasMunicipios,
            manualCoordsMunicipios,
            visitasBairros,
            manualCoordsBairros,
            dadosIDHBairros,
            customBairrosData,
            estadosMetadata,
            style: { size: labelFontSize, weight: labelFontWeight, color: labelFontColor, title: systemTitle, selectionBox: showSelectionBoxFortaleza, balloonPadding: balloonPadding },
            labelSettings: { showNameLabelsBrasil, showNameLabelsCeara, showNameLabelsFortaleza, showNumberLabelsBrasil, showNumberLabelsCeara, showNumberLabelsFortaleza },
            autoCalculate,
            autoBackup,
            featureToggles,
            theme: currentTheme,
            importMetadata,
            exportTimestamp: new Date().toISOString()
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = `configuracao_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        silentLog('Configuração exportada!', "success");
    }

    function importConfigProfessional() {
        if (!confirm('Importar configuração substituirá todos os dados atuais. Um backup automático será criado.')) return;
        
        try {
            const config = JSON.parse(document.getElementById('importArea').value);
            
            if (autoBackup) {
                const backup = createBackup();
                importHistory.push({
                    timestamp: new Date().toISOString(),
                    type: 'full_config_import',
                    backup: backup
                });
            }
            
            if (config.visitasEstados) visitasEstados = config.visitasEstados;
            if (config.manualCoords) manualCoords = config.manualCoords;
            if (config.visitasMunicipios) visitasMunicipios = config.visitasMunicipios;
            if (config.manualCoordsMunicipios) manualCoordsMunicipios = config.manualCoordsMunicipios;
            if (config.visitasBairros) visitasBairros = config.visitasBairros;
            if (config.manualCoordsBairros) manualCoordsBairros = config.manualCoordsBairros;
            if (config.dadosIDHBairros) dadosIDHBairros = config.dadosIDHBairros;
            if (config.customBairrosData) customBairrosData = config.customBairrosData;
            if (config.estadosMetadata) estadosMetadata = config.estadosMetadata;
            if (config.importMetadata) importMetadata = config.importMetadata;
            if (config.featureToggles) featureToggles = config.featureToggles;
            if (config.theme) currentTheme = config.theme;
            
            if (config.style) { 
                labelFontSize = config.style.size || 12; 
                labelFontWeight = config.style.weight || 'bold'; 
                labelFontColor = config.style.color || '#333'; 
                systemTitle = config.style.title || 'Monitoramento de Visitas'; 
                showSelectionBoxFortaleza = config.style.selectionBox || false; 
                balloonPadding = config.style.balloonPadding || '4px 8px';
                
                document.documentElement.style.setProperty('--label-padding', balloonPadding);
                const paddingMatch = balloonPadding.match(/(\d+)px/);
                if (paddingMatch && paddingMatch[1]) {
                    document.getElementById('balloonSizeRange').value = parseInt(paddingMatch[1]);
                    document.getElementById('balloonSizeVal').textContent = balloonPadding;
                }
            }
            
            if (config.labelSettings) { 
                showNameLabelsBrasil = config.labelSettings.showNameLabelsBrasil || false; 
                showNameLabelsCeara = config.labelSettings.showNameLabelsCeara || false; 
                showNameLabelsFortaleza = config.labelSettings.showNameLabelsFortaleza || false; 
                showNumberLabelsBrasil = config.labelSettings.showNumberLabelsBrasil !== undefined ? config.labelSettings.showNumberLabelsBrasil : true; 
                showNumberLabelsCeara = config.labelSettings.showNumberLabelsCeara !== undefined ? config.labelSettings.showNumberLabelsCeara : true; 
                showNumberLabelsFortaleza = config.labelSettings.showNumberLabelsFortaleza !== undefined ? config.labelSettings.showNumberLabelsFortaleza : true; 
            }
            
            if (config.autoCalculate !== undefined) { 
                autoCalculate = config.autoCalculate; 
                document.getElementById('toggleAutoCalculate').checked = autoCalculate; 
            }
            
            if (config.autoBackup !== undefined) {
                autoBackup = config.autoBackup;
                document.getElementById('toggleAutoBackup').checked = autoBackup;
            }
            
            if (config.theme) {
                changeTheme(config.theme);
            }
            
            if (document.getElementById('featureStatisticalAnalysis')) {
                document.getElementById('featureStatisticalAnalysis').checked = featureToggles.statisticalAnalysis;
            }
            toggleStatisticalFeature(featureToggles.statisticalAnalysis);
            
            if (document.getElementById('featurePresentationMode')) {
                document.getElementById('featurePresentationMode').checked = featureToggles.presentationMode;
            }
            togglePresentationFeature(featureToggles.presentationMode);
            
            rebuildIDHIndex();
            calculateSums(); 
            updateMap();
            updateTotalCounter();
            updateSidebarTable();
            if (isPresentationMode) updatePresentationCard();
            updateRanking();
            saveToDatabase();
            addToVersionHistory('Importação', 'Configuração completa importada');
            silentLog('Configurações importadas com sucesso!', "success");
            
        } catch (e) { 
            silentLog('Erro no JSON: ' + e.message, "error"); 
        }
    }

    function clearSelectedFile() {
        currentJsonFile = null;
        document.getElementById('selected-file-info').style.display = 'none';
        document.getElementById('jsonFileInput').value = '';
    }

    function showJsonModal(data, title) {
        const modal = document.getElementById('jsonViewModal');
        const content = document.getElementById('jsonViewContent');
        
        document.querySelector('#jsonViewModal h5').innerHTML = `<i class="fas fa-file-code me-2"></i>${title || 'Visualização JSON'}`;
        
        jsonViewMode = 'formatted';
        updateJsonViewContent(data);
        
        modal.style.display = 'flex';
        
        modal.dataset.jsonData = JSON.stringify(data);
    }

    function switchJsonView(mode) {
        if (!currentJsonFile) return;
        
        jsonViewMode = mode;
        updateJsonViewContent(currentJsonFile.data);
    }

    function updateJsonViewContent(data) {
        const content = document.getElementById('jsonViewContent');
        
        if (jsonViewMode === 'formatted') {
            content.innerHTML = `<pre style="margin:0; font-size:11px;">${JSON.stringify(data, null, 2)}</pre>`;
        } else if (jsonViewMode === 'raw') {
            content.innerHTML = `<pre style="margin:0; font-size:11px;">${JSON.stringify(data)}</pre>`;
        } else if (jsonViewMode === 'stats') {
            const stats = analyzeJsonStructure(data);
            content.innerHTML = `
                <div><strong>Tipo:</strong> ${stats.type}</div>
                <div><strong>Tamanho:</strong> ${stats.size} elementos</div>
                <div><strong>Chaves principais:</strong> ${stats.keys.join(', ')}</div>
                <div><strong>Níveis de profundidade:</strong> ${stats.depth}</div>
                <div><strong>Contém arrays:</strong> ${stats.hasArrays ? 'Sim' : 'Não'}</div>
                <div><strong>Contém objetos:</strong> ${stats.hasObjects ? 'Sim' : 'Não'}</div>
                <hr>
                <div><strong>Preview dos dados:</strong></div>
                <pre style="font-size:10px; max-height:200px; overflow-y:auto;">${JSON.stringify(data, null, 2).substring(0, 500)}${JSON.stringify(data, null, 2).length > 500 ? '...' : ''}</pre>
            `;
        }
    }

    function analyzeJsonStructure(obj, depth = 0, maxDepth = 0) {
        if (depth > maxDepth) maxDepth = depth;
        
        let result = {
            type: Array.isArray(obj) ? 'array' : typeof obj,
            size: Array.isArray(obj) ? obj.length : Object.keys(obj).length,
            keys: Object.keys(obj).slice(0, 10),
            depth: maxDepth,
            hasArrays: false,
            hasObjects: false
        };
        
        if (Array.isArray(obj)) {
            result.hasArrays = true;
            obj.forEach(item => {
                if (item && typeof item === 'object') {
                    result.hasObjects = true;
                    const deeper = analyzeJsonStructure(item, depth + 1, maxDepth);
                    if (deeper.depth > result.depth) result.depth = deeper.depth;
                    if (deeper.hasArrays) result.hasArrays = true;
                    if (deeper.hasObjects) result.hasObjects = true;
                }
            });
        } else if (obj && typeof obj === 'object') {
            result.hasObjects = true;
            Object.values(obj).forEach(val => {
                if (val && typeof val === 'object') {
                    const deeper = analyzeJsonStructure(val, depth + 1, maxDepth);
                    if (deeper.depth > result.depth) result.depth = deeper.depth;
                    if (deeper.hasArrays) result.hasArrays = true;
                    if (deeper.hasObjects) result.hasObjects = true;
                }
            });
        }
        
        return result;
    }

    function closeJsonView() {
        document.getElementById('jsonViewModal').style.display = 'none';
    }

    function importFromViewer() {
        if (!currentJsonFile) {
            silentLog('Nenhum arquivo selecionado', 'warning');
            return;
        }
        
        const targetLevel = document.getElementById('importLevelSelect').value;
        pendingImportData = parseJSONDataProfessional(currentJsonFile.data, targetLevel);
        
        if (!pendingImportData || pendingImportData.items.length === 0) {
            silentLog('Nenhum item válido encontrado para importação', 'warning');
            return;
        }
        
        pendingImportData.duplicates = detectDuplicatesProfessional(pendingImportData.items, targetLevel);
        
        updateImportPreviewProfessional(pendingImportData);
        
        if (pendingImportData.duplicates > 0) {
            document.getElementById('duplicateResolution').style.display = 'block';
        } else {
            document.getElementById('duplicateResolution').style.display = 'none';
        }
        
        closeJsonView();
        showImportConfirmModal(pendingImportData);
    }

    function validateJsonFile() {
        if (!currentJsonFile) {
            silentLog('Nenhum arquivo selecionado', 'warning');
            return;
        }
        
        try {
            const data = currentJsonFile.data;
            const validation = validateJsonStructure(data);
            
            if (validation.valid) {
                silentLog('JSON válido! ' + validation.message, 'success');
            } else {
                silentLog('JSON inválido: ' + validation.message, 'error');
            }
        } catch (error) {
            silentLog('Erro na validação: ' + error.message, 'error');
        }
    }

    function validateJsonStructure(data) {
        try {
            if (!data) {
                return { valid: false, message: 'Dados vazios' };
            }
            
            if (Array.isArray(data)) {
                if (data.length === 0) {
                    return { valid: true, message: 'Array vazio' };
                }
                
                return { valid: true, message: `Array com ${data.length} itens` };
                
            } else if (typeof data === 'object') {
                return { valid: true, message: `Objeto com ${Object.keys(data).length} propriedades` };
            }
            
            return { valid: false, message: 'Formato não reconhecido' };
            
        } catch (error) {
            return { valid: false, message: error.message };
        }
    }

    // ==================== FUNÇÕES DE ANÁLISE ESTATÍSTICA ====================
    function updateStatisticalAnalysis() {
        if (!advancedStats || !featureToggles.statisticalAnalysis) return;
        
        const dataObj = (currentLevel === 'brasil') ? visitasEstados : 
                        (currentLevel === 'ceara') ? visitasMunicipios : visitasBairros;
        
        const values = Object.values(dataObj).filter(v => v > 0);
        
        if (values.length === 0) {
            document.getElementById('stat-mean').textContent = '0';
            document.getElementById('stat-median').textContent = '0';
            document.getElementById('stat-std').textContent = '0';
            document.getElementById('stat-min').textContent = '0';
            document.getElementById('stat-max').textContent = '0';
            document.getElementById('stat-total').textContent = '0';
            document.getElementById('outlier-count').textContent = '0';
            return;
        }
        
        const sum = values.reduce((a, b) => a + b, 0);
        const mean = sum / values.length;
        const sorted = [...values].sort((a, b) => a - b);
        const median = sorted[Math.floor(sorted.length / 2)];
        const min = sorted[0];
        const max = sorted[sorted.length - 1];
        
        const variance = values.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / values.length;
        const stdDev = Math.sqrt(variance);
        
        const q1 = sorted[Math.floor(sorted.length * 0.25)];
        const q3 = sorted[Math.floor(sorted.length * 0.75)];
        const iqr = q3 - q1;
        const lowerBound = q1 - 1.5 * iqr;
        const upperBound = q3 + 1.5 * iqr;
        const outliers = values.filter(v => v < lowerBound || v > upperBound);
        
        document.getElementById('stat-mean').textContent = mean.toFixed(1);
        document.getElementById('stat-median').textContent = median.toFixed(1);
        document.getElementById('stat-std').textContent = stdDev.toFixed(1);
        document.getElementById('stat-min').textContent = min.toFixed(1);
        document.getElementById('stat-max').textContent = max.toFixed(1);
        document.getElementById('stat-total').textContent = sum.toFixed(1);
        document.getElementById('outlier-count').textContent = outliers.length;
        
        analysisCache[currentLevel] = {
            mean, median, stdDev, min, max, sum,
            outliers: outliers.length,
            timestamp: new Date().toISOString()
        };
        
        updateRanking();
    }
    
    function updateRanking() {
        const dataObj = (currentLevel === 'brasil') ? visitasEstados : 
                        (currentLevel === 'ceara') ? visitasMunicipios : visitasBairros;
        
        const items = Object.entries(dataObj)
            .filter(([_, v]) => v > 0)
            .map(([nome, visitas]) => ({ nome, visitas }));
        
        if (items.length === 0) {
            document.getElementById('ranking-mais').innerHTML = '<div class="ranking-item"><span class="position">-</span><span class="name">Sem dados</span><span class="value">0</span></div>';
            document.getElementById('ranking-menos').innerHTML = '<div class="ranking-item"><span class="position">-</span><span class="name">Sem dados</span><span class="value">0</span></div>';
            return;
        }
        
        const sortedMais = [...items].sort((a, b) => b.visitas - a.visitas).slice(0, 5);
        const sortedMenos = [...items].sort((a, b) => a.visitas - b.visitas).slice(0, 5);
        
        let maisHtml = '';
        sortedMais.forEach((item, index) => {
            const posicao = index + 1;
            const medalha = posicao === 1 ? '🥇' : posicao === 2 ? '🥈' : posicao === 3 ? '🥉' : `${posicao}º`;
            maisHtml += `<div class="ranking-item"><span class="position">${medalha}</span><span class="name">${item.nome}</span><span class="value">${item.visitas.toLocaleString()}</span></div>`;
        });
        document.getElementById('ranking-mais').innerHTML = maisHtml;
        
        let menosHtml = '';
        sortedMenos.forEach((item, index) => {
            menosHtml += `<div class="ranking-item"><span class="position">${index + 1}º</span><span class="name">${item.nome}</span><span class="value">${item.visitas.toLocaleString()}</span></div>`;
        });
        document.getElementById('ranking-menos').innerHTML = menosHtml;
    }

    function runAdvancedAnalysis() {
        const analysisType = document.getElementById('analysis-type').value;
        const resultsDiv = document.getElementById('analysis-results');
        
        let html = '';
        
        switch(analysisType) {
            case 'distribution':
                html = generateDistributionAnalysis();
                break;
            case 'correlation':
                html = generateCorrelationAnalysis();
                break;
            case 'quartile':
                html = generateQuartileAnalysis();
                break;
        }
        
        resultsDiv.innerHTML = html;
    }

    function generateDistributionAnalysis() {
        const dataObj = (currentLevel === 'brasil') ? visitasEstados : 
                        (currentLevel === 'ceara') ? visitasMunicipios : visitasBairros;
        
        const values = Object.values(dataObj).filter(v => v > 0);
        
        if (values.length === 0) {
            return '<div class="text-center text-muted p-3">Sem dados para análise</div>';
        }
        
        const sum = values.reduce((a, b) => a + b, 0);
        const mean = sum / values.length;
        const sorted = [...values].sort((a, b) => a - b);
        const median = sorted[Math.floor(sorted.length / 2)];
        
        const p10 = sorted[Math.floor(sorted.length * 0.1)];
        const p25 = sorted[Math.floor(sorted.length * 0.25)];
        const p75 = sorted[Math.floor(sorted.length * 0.75)];
        const p90 = sorted[Math.floor(sorted.length * 0.9)];
        
        return `
            <div class="mb-2"><strong>Análise de Distribuição</strong></div>
            <div class="row g-1">
                <div class="col-6"><small>Média:</small> <b>${mean.toFixed(2)}</b></div>
                <div class="col-6"><small>Mediana:</small> <b>${median.toFixed(2)}</b></div>
                <div class="col-6"><small>P10:</small> <b>${p10.toFixed(2)}</b></div>
                <div class="col-6"><small>P90:</small> <b>${p90.toFixed(2)}</b></div>
                <div class="col-6"><small>Q1:</small> <b>${p25.toFixed(2)}</b></div>
                <div class="col-6"><small>Q3:</small> <b>${p75.toFixed(2)}</b></div>
            </div>
        `;
    }

    function generateCorrelationAnalysis() {
        if (currentLevel !== 'fortaleza') {
            return '<div class="text-center text-muted p-3">Análise de correlação disponível apenas para Fortaleza (IDH x Visitas)</div>';
        }
        
        const pairs = [];
        Object.keys(visitasBairros).forEach(bairro => {
            const visitas = visitasBairros[bairro];
            const idh = getIDHForBairro(bairro);
            if (idh !== null && visitas > 0) {
                pairs.push({ visitas, idh });
            }
        });
        
        if (pairs.length < 3) {
            return '<div class="text-center text-muted p-3">Dados insuficientes para correlação (mínimo 3 pares)</div>';
        }
        
        const n = pairs.length;
        const sumVisitas = pairs.reduce((s, p) => s + p.visitas, 0);
        const sumIdh = pairs.reduce((s, p) => s + p.idh, 0);
        const sumVisitasIdh = pairs.reduce((s, p) => s + p.visitas * p.idh, 0);
        const sumVisitas2 = pairs.reduce((s, p) => s + p.visitas * p.visitas, 0);
        const sumIdh2 = pairs.reduce((s, p) => s + p.idh * p.idh, 0);
        
        const numerator = n * sumVisitasIdh - sumVisitas * sumIdh;
        const denominator = Math.sqrt((n * sumVisitas2 - sumVisitas * sumVisitas) * (n * sumIdh2 - sumIdh * sumIdh));
        const correlation = numerator / denominator;
        
        return `
            <div class="mb-2"><strong>Correlação Visitas x IDH</strong></div>
            <div class="row g-1">
                <div class="col-6"><small>Pearson r:</small> <b>${correlation.toFixed(3)}</b></div>
                <div class="col-6"><small>R²:</small> <b>${(correlation * correlation).toFixed(3)}</b></div>
                <div class="col-12"><small>Amostras:</small> <b>${n}</b></div>
            </div>
        `;
    }

    function generateQuartileAnalysis() {
        const dataObj = (currentLevel === 'brasil') ? visitasEstados : 
                        (currentLevel === 'ceara') ? visitasMunicipios : visitasBairros;
        
        const items = Object.entries(dataObj)
            .filter(([_, v]) => v > 0)
            .map(([name, visitas]) => ({ name, visitas }));
        
        if (items.length < 4) {
            return '<div class="text-center text-muted p-3">Dados insuficientes para análise por quartis (mínimo 4 itens)</div>';
        }
        
        items.sort((a, b) => a.visitas - b.visitas);
        
        const n = items.length;
        const q1Index = Math.floor(n * 0.25);
        const q2Index = Math.floor(n * 0.5);
        const q3Index = Math.floor(n * 0.75);
        
        const q1Value = items[q1Index].visitas;
        const q2Value = items[q2Index].visitas;
        const q3Value = items[q3Index].visitas;
        
        const quartis = {
            'Baixo volume (Q1)': items.filter(i => i.visitas <= q1Value).length,
            'Médio-baixo volume (Q2)': items.filter(i => i.visitas > q1Value && i.visitas <= q2Value).length,
            'Médio-alto volume (Q3)': items.filter(i => i.visitas > q2Value && i.visitas <= q3Value).length,
            'Alto volume (Q4)': items.filter(i => i.visitas > q3Value).length
        };
        
        let html = '<div class="mb-2"><strong>Distribuição por Quartis de Visitas</strong></div>';
        
        Object.entries(quartis).forEach(([name, count]) => {
            const percentage = (count / items.length * 100).toFixed(1);
            html += `<div class="small d-flex justify-content-between"><span>${name}:</span> <b>${count} (${percentage}%)</b></div>`;
        });
        
        html += `<div class="mt-2 small"><strong>Limites dos quartis:</strong><br>Q1: ${q1Value.toLocaleString()}<br>Q2 (Mediana): ${q2Value.toLocaleString()}<br>Q3: ${q3Value.toLocaleString()}</div>`;
        
        return html;
    }

    function exportAnalysisReport() {
        const analysisType = document.getElementById('analysis-type').value;
        const data = {
            timestamp: new Date().toISOString(),
            level: currentLevel,
            analysisType: analysisType,
            data: analysisCache[currentLevel] || {},
            stats: {
                mean: document.getElementById('stat-mean').textContent,
                median: document.getElementById('stat-median').textContent,
                std: document.getElementById('stat-std').textContent,
                min: document.getElementById('stat-min').textContent,
                max: document.getElementById('stat-max').textContent,
                total: document.getElementById('stat-total').textContent
            },
            outliers: document.getElementById('outlier-count').textContent,
            theme: currentTheme,
            top5: getTop5List(),
            bottom5: getBottom5List()
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = `analise_${currentLevel}_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        silentLog('Relatório de análise exportado!', "success");
    }
    
    function getTop5List() {
        const dataObj = (currentLevel === 'brasil') ? visitasEstados : 
                        (currentLevel === 'ceara') ? visitasMunicipios : visitasBairros;
        
        return Object.entries(dataObj)
            .filter(([_, v]) => v > 0)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([nome, visitas]) => ({ nome, visitas }));
    }
    
    function getBottom5List() {
        const dataObj = (currentLevel === 'brasil') ? visitasEstados : 
                        (currentLevel === 'ceara') ? visitasMunicipios : visitasBairros;
        
        return Object.entries(dataObj)
            .filter(([_, v]) => v > 0)
            .sort((a, b) => a[1] - b[1])
            .slice(0, 5)
            .map(([nome, visitas]) => ({ nome, visitas }));
    }

    function copyConfig() { 
        const config = { 
            visitasEstados, 
            manualCoords, 
            visitasMunicipios, 
            manualCoordsMunicipios, 
            visitasBairros, 
            manualCoordsBairros, 
            dadosIDHBairros, 
            customBairrosData, 
            estadosMetadata, 
            style: { size: labelFontSize, weight: labelFontWeight, color: labelFontColor, title: systemTitle, selectionBox: showSelectionBoxFortaleza, balloonPadding: balloonPadding }, 
            labelSettings: { showNameLabelsBrasil, showNameLabelsCeara, showNameLabelsFortaleza, showNumberLabelsBrasil, showNumberLabelsCeara, showNumberLabelsFortaleza }, 
            autoCalculate,
            autoBackup,
            featureToggles,
            theme: currentTheme,
            importMetadata
        }; 
        
        navigator.clipboard.writeText(JSON.stringify(config, null, 2)); 
        silentLog('Configurações copiadas!', "success"); 
    }

    // ==================== NOVA FUNÇÃO: Gerar pacote de dados iniciais ====================
    function generateInitialDataPackage() {
        const initialPackage = {
            visitasEstados,
            manualCoords,
            visitasMunicipios,
            manualCoordsMunicipios,
            visitasBairros,
            manualCoordsBairros,
            dadosIDHBairros,
            customBairrosData,
            estadosMetadata,
            style: { size: labelFontSize, weight: labelFontWeight, color: labelFontColor, title: systemTitle, selectionBox: showSelectionBoxFortaleza, balloonPadding: balloonPadding },
            labelSettings: { showNameLabelsBrasil, showNameLabelsCeara, showNameLabelsFortaleza, showNumberLabelsBrasil, showNumberLabelsCeara, showNumberLabelsFortaleza },
            autoCalculate,
            autoBackup,
            advancedStats,
            importHistory: [],
            lastValidConfig: null,
            importMetadata: {
                lastImportTimestamp: null,
                importCount: 0,
                totalImportedItems: 0
            },
            versionHistory: [],
            analysisCache: {},
            featureToggles,
            theme: currentTheme
        };

        const jsonString = JSON.stringify(initialPackage, null, 4);
        navigator.clipboard.writeText(jsonString).then(() => {
            silentLog('Pacote de configuração inicial copiado para a área de transferência! Agora cole no lugar do objeto INITIAL_DATA.', 'success');
            showToast('Configuração inicial copiada! Cole no código.', 'success');
        }).catch(err => {
            silentLog('Erro ao copiar: ' + err, 'error');
            showToast('Erro ao copiar. Verifique as permissões.', 'error');
        });
    }

    // ==================== FUNÇÕES DE NORMALIZAÇÃO ====================
    function normalizeBairroName(name) {
        if (!name) return "";
        return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
    }

    function rebuildIDHIndex() {
        dadosIDHBairrosPorNomeNorm = {};
        for (let [nome, idh] of Object.entries(dadosIDHBairros)) {
            dadosIDHBairrosPorNomeNorm[normalizeBairroName(nome)] = { nomeOriginal: nome, idh: idh };
        }
        silentLog(`Índice IDH reconstruído: ${Object.keys(dadosIDHBairrosPorNomeNorm).length} bairros`);
    }

    function getIDHForBairro(name) {
        if (!name) return null;
        const normName = normalizeBairroName(name);
        return dadosIDHBairrosPorNomeNorm[normName]?.idh || null;
    }

    function detectarBairrosSemIDH(geoData) {
        const semIDH = [];
        if (geoData && geoData.features) {
            geoData.features.forEach(f => {
                const name = f.properties.bairro || f.properties.NOME_BAIRRO || f.properties.name || f.properties.Nome || f.properties.NOME;
                if (name && getIDHForBairro(name) === null) semIDH.push(name);
            });
        }
        return semIDH;
    }

    function findStateSiglaByName(nome) {
        const estadoMap = { 
            'acre': 'AC', 'alagoas': 'AL', 'amapá': 'AP', 'amazonas': 'AM', 
            'bahia': 'BA', 'ceará': 'CE', 'distrito federal': 'DF', 'espírito santo': 'ES', 
            'goiás': 'GO', 'maranhão': 'MA', 'mato grosso': 'MT', 'mato grosso do sul': 'MS', 
            'minas gerais': 'MG', 'pará': 'PA', 'paraíba': 'PB', 'paraná': 'PR', 
            'pernambuco': 'PE', 'piauí': 'PI', 'rio de janeiro': 'RJ', 'rio grande do norte': 'RN', 
            'rio grande do sul': 'RS', 'rondônia': 'RO', 'roraima': 'RR', 'santa catarina': 'SC', 
            'são paulo': 'SP', 'sergipe': 'SE', 'tocantins': 'TO' 
        };
        const nomeLower = nome.toLowerCase().trim();
        return estadoMap[nomeLower] || null;
    }

    // ==================== FUNÇÕES DE CÁLCULO ====================
    function calculateSums() {
        if (!autoCalculate) return;
        let totalFortaleza = Object.values(visitasBairros).reduce((a, b) => a + b, 0);
        visitasMunicipios["Fortaleza"] = totalFortaleza;
        let totalCeara = Object.values(visitasMunicipios).reduce((a, b) => a + b, 0);
        visitasEstados["CE"] = totalCeara;
        
        const totalEstadosDiv = document.getElementById('total-estados-value');
        if (totalEstadosDiv) {
            const totalEstados = Object.values(visitasEstados).reduce((a, b) => a + b, 0);
            totalEstadosDiv.textContent = totalEstados.toLocaleString('pt-BR');
        }
        
        updateStatisticalAnalysis();
        updateRanking();
        silentLog('Somas recalculadas');
    }

    // ==================== FUNÇÕES DE COR E ESTILO ====================
    function getBrasilColor(d) { 
        return getStateColor(d);
    }
    
    function getIDHColor(idh) { 
        if (idh === null || idh === undefined) return '#e0e0e0'; 
        if (idh >= 0.8) return '#27ae60'; 
        if (idh >= 0.7) return '#52be80'; 
        if (idh >= 0.4) return '#f39c12'; 
        if (idh >= 0.2) return '#e67e22'; 
        if (idh >= 0.1) return '#e74c3c'; 
        return '#c0392b'; 
    }

    function isStateInFilter(v) {
        if (!activeFilter || activeFilter.type !== 'visitas') return true;
        if (activeFilter.label === '0-20') return v >= 0 && v <= 20;
        if (activeFilter.label === '21-50') return v >= 21 && v <= 50;
        if (activeFilter.label === '51-100') return v >= 51 && v <= 100;
        if (activeFilter.label === '101-500') return v >= 101 && v <= 500;
        if (activeFilter.label === '> 500') return v > 500;
        return true;
    }

    function isIDHInFilter(idh) {
        if (!activeFilter || activeFilter.type !== 'idh') return true;
        if (idh === null) return false;
        if (activeFilter.label === 'Muito Alto (≥0.800)') return idh >= 0.8;
        if (activeFilter.label === 'Alto (0.700-0.799)') return idh >= 0.7 && idh < 0.8;
        if (activeFilter.label === 'Médio (0.400-0.699)') return idh >= 0.4 && idh < 0.7;
        if (activeFilter.label === 'Baixo (<0.400)') return idh < 0.4;
        return true;
    }

    function stateStyle(f) {
        let name = f.properties.bairro || f.properties.NOME_BAIRRO || f.properties.name || f.properties.Nome || f.properties.NOME;
        let v = 0, idh = null;
        
        if (currentLevel === 'brasil') { 
            v = visitasEstados[f.properties.sigla || f.id] || 0; 
        }
        else if (currentLevel === 'ceara') { 
            v = visitasMunicipios[name] || 0; 
        }
        else { 
            const normName = normalizeBairroName(name); 
            for (let key in visitasBairros) { 
                if (normalizeBairroName(key) === normName) { 
                    v = visitasBairros[key]; 
                    break; 
                } 
            } 
            idh = getIDHForBairro(name); 
        }
        
        let color;
        if (currentLevel === 'fortaleza' && currentViewMode === 'idh') { 
            color = getIDHColor(idh); 
        }
        else { 
            color = getStateColor(v); 
        }
        
        let opacity = 0.7, borderOpacity = 1, weight = 2, borderColor = '#333';
        const normName = normalizeBairroName(name);
        let isSelected = false;
        for (let selected of selectedItems) { 
            if (normalizeBairroName(selected) === normName) { 
                isSelected = true; 
                break; 
            } 
        }
        
        if (isSelected) { 
            weight = 5; 
            borderColor = '#007bff'; 
            opacity = 0.9; 
        }
        
        if (activeFilter) {
            if (activeFilter.type === 'visitas' && !isStateInFilter(v)) { 
                opacity = 0.1; 
                borderOpacity = 0.3; 
            }
            if (activeFilter.type === 'idh' && !isIDHInFilter(idh)) { 
                opacity = 0.1; 
                borderOpacity = 0.3; 
            }
        }
        
        return { 
            fillColor: color, 
            weight: weight, 
            opacity: borderOpacity, 
            color: borderColor, 
            dashArray: isSelected ? '0' : '3', 
            fillOpacity: opacity 
        };
    }

    // ==================== FUNÇÕES DE MAPA ====================
    function updateMap() {
        if (!geojsonLayer) return;
        geojsonLayer.eachLayer(layer => { geojsonLayer.resetStyle(layer); });
        if (customBairrosLayer) { 
            customBairrosLayer.eachLayer(layer => { customBairrosLayer.resetStyle(layer); }); 
        }
        updateSidebarTable(); 
        renderLabels();
        updateTotalCounter();
        applySelectionStyle();
        updateStatisticalAnalysis();
        updateRanking();
        silentLog('Mapa atualizado');
    }

    function changeViewMode(mode) {
        currentViewMode = mode;
        activeFilter = null;
        updateLegend();
        updateMap();
        updateIDHTabVisibility();
        updateComparisonPanel();
    }

    function calculateCentroid(feature) {
        if (!feature || !feature.geometry) return null;
        try {
            let latSum = 0, lngSum = 0, count = 0;
            const processCoords = (coordsArray) => {
                if (Array.isArray(coordsArray) && coordsArray.length > 0) {
                    if (typeof coordsArray[0] === 'number' && coordsArray.length >= 2) {
                        lngSum += coordsArray[0];
                        latSum += coordsArray[1];
                        count++;
                    } else { 
                        coordsArray.forEach(item => processCoords(item)); 
                    }
                }
            };
            
            if (feature.geometry.type === 'Polygon') { 
                feature.geometry.coordinates.forEach(polygon => processCoords(polygon)); 
            }
            else if (feature.geometry.type === 'MultiPolygon') { 
                feature.geometry.coordinates.forEach(polygon => { 
                    polygon.forEach(ring => processCoords(ring)); 
                }); 
            }
            
            if (count > 0) { 
                return [latSum / count, lngSum / count]; 
            }
        } catch (e) { 
            silentLog(`Erro ao calcular centróide: ${e}`, 'error');
        }
        return null;
    }

    function ensureAllMunicipioCoords() {
        if (!cearaData || !cearaData.features) return;
        let coordsCalculated = 0;
        cearaData.features.forEach(feature => {
            let name = feature.properties.name || feature.properties.Nome || feature.properties.NOME;
            if (!name) return;
            if (!manualCoordsMunicipios[name]) {
                const centroid = calculateCentroid(feature);
                if (centroid) { 
                    manualCoordsMunicipios[name] = centroid; 
                    coordsCalculated++; 
                }
            }
        });
        if (coordsCalculated > 0) { 
            silentLog(`Coordenadas calculadas para ${coordsCalculated} municípios do Ceará`); 
            saveToDatabase(); 
        }
    }

    function ensureAllBairroCoords() {
        if (!fortalezaData || !fortalezaData.features) return;
        let coordsCalculated = 0;
        fortalezaData.features.forEach(feature => {
            let name = feature.properties.bairro || feature.properties.NOME_BAIRRO || feature.properties.name || feature.properties.Nome || feature.properties.NOME;
            if (!name) return;
            const normName = normalizeBairroName(name);
            let foundKey = null;
            for (let key in visitasBairros) { 
                if (normalizeBairroName(key) === normName) { 
                    foundKey = key; 
                    break; 
                } 
            }
            if (!foundKey) foundKey = name;
            if (!manualCoordsBairros[foundKey]) {
                const centroid = calculateCentroid(feature);
                if (centroid) { 
                    manualCoordsBairros[foundKey] = centroid; 
                    coordsCalculated++; 
                }
            }
        });
        
        if (customBairrosData && customBairrosData.features) {
            customBairrosData.features.forEach(feature => {
                let name = feature.properties.name;
                if (!name) return;
                if (!manualCoordsBairros[name]) {
                    const centroid = calculateCentroid(feature);
                    if (centroid) { 
                        manualCoordsBairros[name] = centroid; 
                        coordsCalculated++; 
                    }
                }
            });
        }
        
        if (coordsCalculated > 0) { 
            silentLog(`Coordenadas calculadas para ${coordsCalculated} bairros de Fortaleza`); 
            saveToDatabase(); 
        }
    }

    function ensureAllStateCoords() {
        if (!statesData || !statesData.features) return;
        let coordsCalculated = 0;
        statesData.features.forEach(feature => {
            let sigla = feature.properties.sigla || feature.id;
            if (!sigla) return;
            if (!manualCoords[sigla]) {
                const centroid = calculateCentroid(feature);
                if (centroid) { 
                    manualCoords[sigla] = centroid; 
                    coordsCalculated++; 
                }
            }
        });
        if (coordsCalculated > 0) { 
            silentLog(`Coordenadas calculadas para ${coordsCalculated} estados`); 
            saveToDatabase(); 
        }
    }

    function togglePresentationMode() {
        isPresentationMode = !isPresentationMode;
        document.body.classList.toggle('presentation-mode', isPresentationMode);
        document.getElementById('presControls').style.display = isPresentationMode ? 'flex' : 'none';
        document.getElementById('presCard').style.display = isPresentationMode ? 'block' : 'none';
        
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.style.display = isPresentationMode ? 'none' : 'flex';
        }
        
        if (isPresentationMode) {
            showToast("Modo Apresentação Ativado", "info");
            updatePresentationCard();
            if (currentLevel === 'brasil') {
                map.flyTo([-5.2, -39.5], 7, { duration: 2 });
            }
        } else {
            stopAutoTour();
            if (!featureToggles.presentationMode) {
                document.getElementById('presentationToggleBtn').style.display = 'none';
            }
        }
    }

    function updatePresentationCard() {
        if (!isPresentationMode) return;

        const title = document.getElementById('presTitle');
        const visitas = document.getElementById('presVisitas');
        const idh = document.getElementById('presIdh');
        const idhContainer = document.getElementById('presIdhContainer');
        
        let totalVisitas = 0;
        let chartData = [];
        let chartLabels = [];

        if (currentLevel === 'brasil') {
            title.innerText = "Brasil - Visão Geral";
            totalVisitas = Object.values(visitasEstados).reduce((a, b) => a + b, 0);
            idhContainer.style.display = 'none';
            const top = Object.entries(visitasEstados).sort((a,b) => b[1]-a[1]).slice(0, 5);
            chartLabels = top.map(s => s[0]);
            chartData = top.map(s => s[1]);
        } else if (currentLevel === 'ceara') {
            title.innerText = "Ceará - Municípios";
            totalVisitas = Object.values(visitasMunicipios).reduce((a, b) => a + b, 0);
            idhContainer.style.display = 'none';
            const top = Object.entries(visitasMunicipios).sort((a,b) => b[1]-a[1]).slice(0, 5);
            chartLabels = top.map(m => m[0]);
            chartData = top.map(m => m[1]);
        } else {
            title.innerText = "Fortaleza - Bairros";
            totalVisitas = Object.values(visitasBairros).reduce((a, b) => a + b, 0);
            idhContainer.style.display = 'block';
            const idhs = Object.keys(visitasBairros).map(b => getIDHForBairro(b)).filter(v => v !== null);
            const avgIDH = idhs.length ? (idhs.reduce((a,b) => a+b, 0) / idhs.length) : 0;
            idh.innerText = avgIDH.toFixed(3);
            const top = Object.entries(visitasBairros).sort((a,b) => b[1]-a[1]).slice(0, 5);
            chartLabels = top.map(b => b[0]);
            chartData = top.map(b => b[1]);
        }

        visitas.innerText = totalVisitas.toLocaleString();
        renderPresChart(chartLabels, chartData);
    }

    function renderPresChart(labels, data) {
        const ctx = document.getElementById('presChart').getContext('2d');
        if (presChartInstance) presChartInstance.destroy();

        presChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#0984e3', '#00b894', '#fdcb6e', '#d63031', '#6c5ce7'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                },
                cutout: '75%'
            }
        });
    }

    function toggleAutoTour() {
        if (tourInterval) stopAutoTour();
        else startAutoTour();
    }

    function startAutoTour() {
        const levels = ['brasil', 'ceara', 'fortaleza'];
        let idx = levels.indexOf(currentLevel);
        document.getElementById('btnTour').innerHTML = '<i class="fas fa-pause"></i> Pausar Tour';
        document.getElementById('btnTour').classList.add('active');
        
        const animateBar = () => {
            $('#tourTimer').stop().css('width', '0%').animate({width: '100%'}, 6000, 'linear');
        };
        
        animateBar();
        tourInterval = setInterval(() => {
            idx = (idx + 1) % levels.length;
            switchLevel(levels[idx]);
            animateBar();
        }, 6000);
    }

    function stopAutoTour() {
        clearInterval(tourInterval);
        tourInterval = null;
        document.getElementById('btnTour').innerHTML = '<i class="fas fa-play"></i> Tour Automático';
        document.getElementById('btnTour').classList.remove('active');
        $('#tourTimer').stop().css('width', '0%');
    }

    function createCearaExplosion(latlng) {
        const point = map.latLngToContainerPoint(latlng);
        confetti({
            particleCount: 150, spread: 70,
            origin: { x: point.x / window.innerWidth, y: point.y / window.innerHeight },
            colors: ['#ff4757', '#ffffff', '#2ed573']
        });

        for (let i = 0; i < 25; i++) {
            const p = document.createElement('div');
            p.className = 'ceara-particle';
            const size = Math.random() * 12 + 6;
            p.style.width = size + 'px'; p.style.height = size + 'px';
            p.style.left = point.x + 'px'; p.style.top = point.y + 'px';
            p.style.setProperty('--tx', (Math.random() - 0.5) * 250 + 'px');
            p.style.setProperty('--ty', (Math.random() - 0.5) * 250 + 'px');
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1000);
        }
    }

    async function switchLevel(level) {
        silentLog(`Mudando nível para: ${level}`);
        selectedItems.clear();
        currentLevel = level;
        
        document.querySelectorAll('.nav-map-levels button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-lvl-' + level).classList.add('active');
        
        document.getElementById('stats-title').textContent = level === 'brasil' ? 'Visitas por Estado' : (level === 'ceara' ? 'Visitas por Município' : 'Visitas por Bairro');
        document.getElementById('stats-col-name').textContent = level === 'brasil' ? 'Estado' : (level === 'ceara' ? 'Município' : 'Bairro');
        
        const idhCol = document.getElementById('stats-col-idh');
        idhCol.style.display = level === 'fortaleza' ? 'table-cell' : 'none';
        
        updateIDHTabVisibility();
        
        const comparisonPanel = document.getElementById('idh-comparison-panel');
        
        const showNamesLvl = (level === 'brasil') ? showNameLabelsBrasil : (level === 'ceara') ? showNameLabelsCeara : showNameLabelsFortaleza;
        const showNumbersLvl = (level === 'brasil') ? showNumberLabelsBrasil : (level === 'ceara') ? showNumberLabelsCeara : showNumberLabelsFortaleza;
        
        document.getElementById('toggleNameLabels').checked = showNamesLvl;
        document.getElementById('toggleLabels').checked = showNumbersLvl;
        
        const viewModeContainer = document.getElementById('view-mode-container');
        if (level === 'fortaleza') { 
            viewModeContainer.style.display = 'block'; 
        }
        else { 
            viewModeContainer.style.display = 'none'; 
            currentViewMode = 'visitas'; 
            document.getElementById('modeVisitas').checked = true; 
        }
        
        if (geojsonLayer) map.removeLayer(geojsonLayer);
        activeFilter = null; 
        updateLegend();
        
        let data = (level === 'brasil') ? statesData : (level === 'ceara' ? cearaData : fortalezaData);
        if (data) {
            geojsonLayer = L.geoJson(data, {
                style: stateStyle,
                onEachFeature: function(f, l) {
                    let name = f.properties.bairro || f.properties.NOME_BAIRRO || f.properties.name || f.properties.Nome || f.properties.NOME;
                    let v = 0;
                    if (level === 'brasil') { 
                        v = visitasEstados[f.properties.sigla || f.id] || 0; 
                    }
                    else if (level === 'ceara') { 
                        v = visitasMunicipios[name] || 0; 
                    }
                    else { 
                        const normName = normalizeBairroName(name); 
                        for (let key in visitasBairros) { 
                            if (normalizeBairroName(key) === normName) { 
                                v = visitasBairros[key]; 
                                break; 
                            } 
                        } 
                    }
                    
                    let popupContent = `<b>${name}</b><br>Visitas: ${v.toLocaleString()}`;
                    if (level === 'fortaleza') { 
                        let idh = getIDHForBairro(name); 
                        if (idh !== null) popupContent += `<br>IDH: ${idh.toFixed(3)}`; 
                    }
                    
                    l.bindPopup(popupContent, { autoClose: false, closeOnClick: false });
                    l.bindTooltip(`<b>${name}</b>`, { sticky: true, opacity: 0.9 });
                    
                    l.on('mouseover', function() { 
                        this.setStyle({ weight: 3, color: '#666', fillOpacity: 0.9 }); 
                    });
                    
                    l.on('mouseout', function() { 
                        geojsonLayer.resetStyle(this); 
                    });
                    
                    l.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        if (level === 'brasil' && (f.properties.sigla === 'CE' || f.id === 'CE')) { 
                            if (isPresentationMode) createCearaExplosion(e.latlng);
                            switchLevel('ceara'); 
                        }
                        else if (level === 'ceara' && name === 'Fortaleza') { 
                            switchLevel('fortaleza'); 
                        }
                        else { 
                            selectItem(name, true); 
                            currentDetailItem = { 
                                name: name, 
                                level: level, 
                                visitas: v, 
                                idh: getIDHForBairro(name) 
                            }; 
                        }
                    });
                }
            }).addTo(map);
            
            if (customBairrosLayer) map.removeLayer(customBairrosLayer);
            if (customBairrosData && customBairrosData.features.length > 0) {
                customBairrosLayer = L.geoJson(customBairrosData, {
                    style: stateStyle,
                    onEachFeature: function(f, l) {
                        let name = f.properties.name;
                        let v = visitasBairros[name] || 0;
                        l.bindPopup(`<b>${name}</b><br>Visitas: ${v.toLocaleString()}<br>IDH: ${getIDHForBairro(name)?.toFixed(3) || 'N/D'}`);
                        l.bindTooltip(`<b>${name}</b>`, { sticky: true });
                        
                        l.on('mouseover', function() { 
                            this.setStyle({ weight: 3, color: '#666', fillOpacity: 0.9 }); 
                        });
                        
                        l.on('mouseout', function() { 
                            customBairrosLayer.resetStyle(this); 
                        });
                        
                        l.on('click', function(e) { 
                            L.DomEvent.stopPropagation(e); 
                            selectItem(name, true); 
                        });
                    }
                }).addTo(map);
            }
            fitMap();
        }
        
        if (level === 'brasil') ensureAllStateCoords();
        else if (level === 'ceara') ensureAllMunicipioCoords();
        else if (level === 'fortaleza') ensureAllBairroCoords();
        
        updateContainerVisibility(level);
        updateMap();
        updateRanking();
        if (isPresentationMode) updatePresentationCard();
        await saveToDatabase();
        silentLog(`Nível alterado para ${level}`, 'success');
    }

    function fitMap() { 
        if (geojsonLayer) { 
            const bounds = geojsonLayer.getBounds(); 
            if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50], animate: true, duration: 1.5 }); 
        }
        else if (customBairrosLayer && currentLevel === 'fortaleza') {
            const bounds = customBairrosLayer.getBounds();
            if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50], animate: true, duration: 1.5 });
        }
    }

    function selectItem(name, isMultiSelect = true) {
        const normName = normalizeBairroName(name);
        let foundKey = name;
        for (let key of Object.keys(visitasBairros)) { 
            if (normalizeBairroName(key) === normName) { 
                foundKey = key; 
                break; 
            } 
        }
        
        if (!selectedItems.has(foundKey)) { 
            selectedItems.add(foundKey); 
        }
        
        applySelectionStyle();
        renderLabels();
        updateComparisonPanel();
        saveToDatabase();
        silentLog(`Item selecionado: ${name}`);
    }

    function applySelectionStyle() {
        if (!geojsonLayer) return;
        
        geojsonLayer.eachLayer(l => {
            let name = l.feature.properties.bairro || l.feature.properties.NOME_BAIRRO || l.feature.properties.name || l.feature.properties.Nome || l.feature.properties.NOME;
            const normName = normalizeBairroName(name);
            let isSelected = false;
            for (let selected of selectedItems) { 
                if (normalizeBairroName(selected) === normName) { 
                    isSelected = true; 
                    break; 
                } 
            }
            
            geojsonLayer.resetStyle(l);
            if (isSelected) { 
                l.setStyle({ weight: 5, color: '#007bff', dashArray: '0', fillOpacity: 0.9 }); 
                l.openPopup(); 
            }
            else { 
                l.closePopup(); 
            }
        });
        
        if (customBairrosLayer) {
            customBairrosLayer.eachLayer(l => {
                let name = l.feature.properties.name;
                const normName = normalizeBairroName(name);
                let isSelected = false;
                for (let selected of selectedItems) { 
                    if (normalizeBairroName(selected) === normName) { 
                        isSelected = true; 
                        break; 
                    } 
                }
                
                customBairrosLayer.resetStyle(l);
                if (isSelected) { 
                    l.setStyle({ weight: 5, color: '#007bff', dashArray: '0', fillOpacity: 0.9 }); 
                    l.openPopup(); 
                }
                else { 
                    l.closePopup(); 
                }
            });
        }
    }

    function updateComparisonPanel() {
        const panel = document.getElementById('idh-comparison-panel');
        const countSpan = document.getElementById('comparison-count');
        const listDiv = document.getElementById('comparison-list');
        const statsDiv = document.getElementById('comparison-stats');
        
        if (currentLevel !== 'fortaleza' || currentViewMode !== 'idh' || selectedItems.size === 0) { 
            panel.style.display = 'none'; 
            return; 
        }
        
        panel.style.display = 'block';
        countSpan.textContent = selectedItems.size;
        
        let listHtml = '';
        let idhValues = [];
        
        selectedItems.forEach(name => {
            const v = visitasBairros[name] || 0;
            const idh = getIDHForBairro(name);
            if (idh !== null) idhValues.push(idh);
            listHtml += `<div class="comparison-item"><span class="name">${name}</span><span class="value">Visitas: ${v.toLocaleString()} | IDH: ${idh !== null ? idh.toFixed(3) : 'N/D'}</span></div>`;
        });
        
        listDiv.innerHTML = listHtml;
        
        if (idhValues.length > 0) {
            const media = idhValues.reduce((a, b) => a + b, 0) / idhValues.length;
            const maximo = Math.max(...idhValues);
            const minimo = Math.min(...idhValues);
            const variancia = idhValues.reduce((acc, val) => acc + Math.pow(val - media, 2), 0) / idhValues.length;
            const desvio = Math.sqrt(variancia);
            
            statsDiv.innerHTML = `
                <div class="stat-row"><span>IDH Médio:</span> <strong>${media.toFixed(3)}</strong></div>
                <div class="stat-row"><span>IDH Máximo:</span> <strong>${maximo.toFixed(3)}</strong></div>
                <div class="stat-row"><span>IDH Mínimo:</span> <strong>${minimo.toFixed(3)}</strong></div>
                <div class="stat-row"><span>Desvio Padrão:</span> <strong>±${desvio.toFixed(3)}</strong></div>
            `;
        } else { 
            statsDiv.innerHTML = '<div class="stat-row">Nenhum IDH disponível.</div>'; 
        }
    }

    function renderLabels() {
        document.documentElement.style.setProperty('--label-font-size', labelFontSize + 'px');
        
        labelsLayer.clearLayers();
        
        let dataObj = (currentLevel === 'brasil') ? visitasEstados : (currentLevel === 'ceara' ? visitasMunicipios : visitasBairros);
        let coordsObj = (currentLevel === 'brasil') ? manualCoords : (currentLevel === 'ceara' ? manualCoordsMunicipios : manualCoordsBairros);
        
        Object.keys(dataObj).forEach(key => {
            const v = dataObj[key] || 0;
            let labelVisible = true;
            
            if (activeFilter) {
                if (activeFilter.type === 'visitas' && !isStateInFilter(v)) labelVisible = false;
                if (currentLevel === 'fortaleza' && activeFilter.type === 'idh') {
                    const idh = getIDHForBairro(key);
                    if (!isIDHInFilter(idh)) labelVisible = false;
                }
            }
            
            if (v > 0 && labelVisible) {
                let coords = coordsObj[key];
                
                if (!coords) {
                    let feature = null;
                    if (currentLevel === 'brasil' && statesData) { 
                        feature = statesData.features.find(f => (f.properties.sigla || f.id) === key); 
                    }
                    else if (currentLevel === 'ceara' && cearaData) { 
                        feature = cearaData.features.find(f => f.properties.name === key || f.properties.Nome === key || f.properties.NOME === key); 
                    }
                    else if (currentLevel === 'fortaleza') {
                        if (fortalezaData) { 
                            const normKey = normalizeBairroName(key); 
                            feature = fortalezaData.features.find(f => { 
                                const name = f.properties.bairro || f.properties.NOME_BAIRRO || f.properties.name || f.properties.Nome || f.properties.NOME; 
                                return normalizeBairroName(name) === normKey; 
                            }); 
                        }
                        if (!feature && customBairrosData && customBairrosData.features) { 
                            feature = customBairrosData.features.find(f => f.properties.name === key); 
                        }
                    }
                    
                    if (feature) { 
                        coords = calculateCentroid(feature); 
                        if (coords) { 
                            coordsObj[key] = coords; 
                        } 
                    }
                }
                
                const isHighlight = (currentLevel === 'brasil' && key === 'CE') || (currentLevel === 'ceara' && key === 'Fortaleza');
                
                if (!coords || isNaN(coords[0]) || isNaN(coords[1])) return;
                
                let displayName = key;
                if (currentLevel === 'brasil' && estadosMetadata[key]) { 
                    displayName = estadosMetadata[key].nome || key; 
                }
                
                let labelClasses = 'state-label';
                if (isHighlight) labelClasses += ' highlight-ce';
                
                let labelHtml = `<div id="label-${key}" class="${labelClasses}" style="font-weight:${labelFontWeight}; color:${labelFontColor};">`;
                
                const showNames = (currentLevel === 'brasil') ? showNameLabelsBrasil : (currentLevel === 'ceara') ? showNameLabelsCeara : showNameLabelsFortaleza;
                const showNumbers = (currentLevel === 'brasil') ? showNumberLabelsBrasil : (currentLevel === 'ceara') ? showNumberLabelsCeara : showNumberLabelsFortaleza;
                
                if (!showNames && !showNumbers) return;
                
                const isSelected = selectedItems.has(key);
                
                if (showNames) {
                    labelHtml += `<b>${displayName}</b>`;
                    if (showNumbers || isSelected) {
                        labelHtml += `<span class="visitas-number">${v.toLocaleString()}</span>`;
                    }
                } else if (showNumbers || isSelected) { 
                    labelHtml += `<b>${v.toLocaleString()}</b>`; 
                }
                
                if (currentLevel === 'fortaleza') {
                    const idh = getIDHForBairro(key);
                    if (isSelected && idh !== null) { 
                        labelHtml += `<div style="font-size: 0.8em; color: ${labelFontColor}; margin-top: 2px;">IDH: ${idh.toFixed(3)}</div>`; 
                    }
                    if (showSelectionBoxFortaleza) { 
                        const isChecked = isSelected ? 'checked' : ''; 
                        labelHtml += `<div style="margin-top:4px; border-top:1px solid ${labelFontColor}44; padding-top:2px;"><input type="checkbox" ${isChecked} onclick="toggleBairroSelection('${key}', event)" id="check-${key}"></div>`; 
                    }
                }
                
                labelHtml += `</div>`;
                
                const marker = L.marker(coords, { 
                    draggable: true, 
                    icon: L.divIcon({ 
                        className: `state-label-container`, 
                        html: labelHtml, 
                        iconSize: [null, null], 
                        iconAnchor: [30, 20]
                    }) 
                });
                
                marker.on('dragend', async function(e) { 
                    const newPos = e.target.getLatLng(); 
                    coordsObj[key] = [parseFloat(newPos.lat.toFixed(4)), parseFloat(newPos.lng.toFixed(4))]; 
                    updateAdminCoords(); 
                    await saveToDatabase(); 
                    silentLog(`Coordenada atualizada para ${key}`);
                });
                
                marker.on('click', function(e) { 
                    L.DomEvent.stopPropagation(e); 
                    selectItem(key, true); 
                });
                
                labelsLayer.addLayer(marker);
            }
        });
        silentLog(`Rótulos renderizados: ${labelsLayer.getLayers().length} itens`);
    }

    // ==================== FUNÇÕES DE DETALHES ====================
    function showDetails() {
        if (!currentDetailItem) return;
        
        const item = currentDetailItem;
        let content = `
            <div class="details-stat">
                <div class="details-stat-label">Nome</div>
                <div class="details-stat-value">${item.name}</div>
            </div>
            <div class="details-stat">
                <div class="details-stat-label">Visitas</div>
                <div class="details-stat-value">${item.visitas.toLocaleString()}</div>
            </div>
        `;
        
        if (item.idh !== null) { 
            content += `
                <div class="details-stat">
                    <div class="details-stat-label">IDH</div>
                    <div class="details-stat-value">${item.idh.toFixed(3)}</div>
                </div>
            `; 
        }
        
        document.getElementById('details-title').textContent = item.name;
        
        content += `
            <div class="details-stat">
                <div class="details-stat-label">Informação Detalhada</div>
                <div class="details-stat-value" style="font-size: 14px; font-weight: 400; line-height: 1.6; color: #444; text-align: justify;">
                    ${descricoesBairros[item.name] || descricoesBairros["default"]}
                </div>
            </div>
        `;
        
        document.getElementById('details-content').innerHTML = content;
        document.getElementById('detailsOverlay').style.display = 'block';
        document.getElementById('detailsPanel').style.display = 'block';
    }

    function closeDetails() {
        document.getElementById('detailsOverlay').style.display = 'none';
        document.getElementById('detailsPanel').style.display = 'none';
        currentDetailItem = null;
    }

    function deleteCurrentItem() {
        if (!currentDetailItem) return;
        
        const name = currentDetailItem.name, level = currentDetailItem.level;
        
        if (level === 'fortaleza') { 
            deleteBairro(name); 
            closeDetails(); 
        }
        else if (level === 'ceara') { 
            deleteMunicipio(name); 
            closeDetails(); 
        }
        else if (level === 'brasil') { 
            deleteEstado(name); 
            closeDetails(); 
        }
        else { 
            silentLog("Não é possível excluir este item.", "warning"); 
        }
    }

    function editDetailItem() {
        if (!currentDetailItem) return;
        
        const level = currentDetailItem.level, name = currentDetailItem.name;
        closeDetails();
        
        const adminPanel = document.getElementById('adminPanel');
        adminPanel.style.display = 'block';
        document.getElementById('admin-level-select').value = level;
        changeAdminLevel(level);
        
        if (level === 'fortaleza') { 
            const idhTab = document.getElementById('idh-tab'); 
            if (idhTab) bootstrap.Tab.getOrCreateInstance(idhTab).show(); 
        }
        else { 
            const dataTab = document.getElementById('data-tab'); 
            if (dataTab) bootstrap.Tab.getOrCreateInstance(dataTab).show(); 
        }
        
        setTimeout(() => {
            const listId = level === 'fortaleza' ? 'idh-edit-list' : 'state-edit-list';
            const list = document.getElementById(listId);
            if (list) {
                const items = list.querySelectorAll('.estado-edit-row, .state-edit-row, .idh-edit-row');
                for (let item of items) {
                    if (item.textContent.includes(name)) {
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        item.style.backgroundColor = '#fff3cd';
                        setTimeout(() => item.style.backgroundColor = '', 2000);
                        break;
                    }
                }
            }
        }, 300);
    }

    function deleteBairro(bairro) {
        if (!confirm(`Deseja realmente excluir o bairro "${bairro}"?`)) return;
        
        const normName = normalizeBairroName(bairro);
        
        for (let key in dadosIDHBairros) { 
            if (normalizeBairroName(key) === normName) delete dadosIDHBairros[key]; 
        }
        
        for (let key in visitasBairros) { 
            if (normalizeBairroName(key) === normName) delete visitasBairros[key]; 
        }
        
        for (let key in manualCoordsBairros) { 
            if (normalizeBairroName(key) === normName) delete manualCoordsBairros[key]; 
        }
        
        if (fortalezaData && fortalezaData.features) { 
            fortalezaData.features = fortalezaData.features.filter(f => { 
                const name = f.properties.bairro || f.properties.NOME_BAIRRO || f.properties.name || f.properties.Nome || f.properties.NOME; 
                return normalizeBairroName(name) !== normName; 
            }); 
        }
        
        if (customBairrosData && customBairrosData.features) { 
            customBairrosData.features = customBairrosData.features.filter(f => { 
                return normalizeBairroName(f.properties.name) !== normName; 
            }); 
        }
        
        if (selectedItems.has(bairro)) selectedItems.delete(bairro);
        
        rebuildIDHIndex();
        updateAdminList();
        updateIDHList();
        updateMap();
        updateComparisonPanel();
        updateRanking();
        saveToDatabase();
        addToVersionHistory('Exclusão', `Bairro ${bairro} removido`);
        silentLog(`Bairro "${bairro}" removido completamente.`, "success");
    }

    function deleteMunicipio(municipio) {
        if (!confirm(`Deseja realmente excluir o município "${municipio}"?`)) return;
        
        delete visitasMunicipios[municipio];
        delete manualCoordsMunicipios[municipio];
        
        updateAdminList();
        updateMap();
        updateRanking();
        saveToDatabase();
        addToVersionHistory('Exclusão', `Município ${municipio} removido`);
        silentLog(`Município "${municipio}" removido.`, "success");
    }

    function deleteEstado(estado) {
        if (!confirm(`Deseja realmente excluir o estado "${estado}"?`)) return;
        
        delete visitasEstados[estado];
        delete manualCoords[estado];
        delete estadosMetadata[estado];
        
        updateAdminList();
        updateMap();
        updateRanking();
        saveToDatabase();
        addToVersionHistory('Exclusão', `Estado ${estado} removido`);
        silentLog(`Estado "${estado}" removido.`, "success");
    }

    function toggleAdmin() { 
        $('#adminPanel').toggle(); 
        updateAdminList(); 
        updateIDHList(); 
        updateIDHBairroSelect(); 
    }
    
    function changeAdminLevel(level) { 
        adminLevel = level; 
        
        if (document.getElementById('selection-box-option')) {
            document.getElementById('selection-box-option').style.display = (level === 'fortaleza') ? 'block' : 'none';
        }
        
        updateContainerVisibility(level);
        if (level === 'fortaleza') { 
            updateIDHBairroSelect(); 
        }
        
        updateAdminList(); 
    }
    
    function updateAdminList() {
        const list = document.getElementById('state-edit-list'); 
        if (!list) return; 
        list.innerHTML = '';
        
        if (adminLevel === 'brasil') {
            const dataObj = visitasEstados;
            if (Object.keys(dataObj).length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = `<i class="fas fa-flag"></i><h6>Nenhum estado cadastrado</h6><p>Utilize o formulário abaixo para adicionar estados.</p>`;
                list.appendChild(emptyDiv);
            } else {
                Object.keys(dataObj).sort().forEach(sigla => {
                    const row = document.createElement('div'); 
                    row.className = 'estado-edit-row';
                    const nomeEstado = estadosMetadata[sigla]?.nome || sigla;
                    const visitas = dataObj[sigla] || 0;
                    row.innerHTML = `
                        <input type="text" class="form-control form-control-sm sigla-input" value="${sigla}" maxlength="2" onchange="updateEstadoSigla('${sigla}', this.value)">
                        <input type="text" class="form-control form-control-sm nome-input" value="${nomeEstado}" placeholder="Nome" onchange="updateEstadoNome('${sigla}', this.value)">
                        <input type="number" class="form-control form-control-sm visitas-input" value="${visitas}" onchange="updateDataValue('${sigla}', this.value)">
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm" onclick="showEstadoDetails('${sigla}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteDataKey('${sigla}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(row);
                });
            }
        } else if (adminLevel === 'ceara') {
            const dataObj = visitasMunicipios;
            if (Object.keys(dataObj).length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = `<i class="fas fa-city"></i><h6>Nenhum município cadastrado</h6><p>Utilize o formulário abaixo para adicionar municípios.</p>`;
                list.appendChild(emptyDiv);
            } else {
                Object.keys(dataObj).sort().forEach(key => {
                    const row = document.createElement('div'); 
                    row.className = 'state-edit-row';
                    row.innerHTML = `
                        <input type="text" class="form-control form-control-sm fw-bold me-2" style="width:150px" value="${key}" onchange="renameDataKey('${key}', this.value)">
                        <input type="number" class="form-control form-control-sm me-2" value="${dataObj[key]}" onchange="updateDataValue('${key}', this.value)">
                        <button class="btn btn-outline-danger btn-sm p-1" style="font-size:10px" onclick="deleteDataKey('${key}')"><i class="fas fa-trash"></i></button>
                    `;
                    list.appendChild(row);
                });
            }
        } else if (adminLevel === 'fortaleza') {
            const dataObj = visitasBairros;
            if (Object.keys(dataObj).length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = `<i class="fas fa-map-marked-alt"></i><h6>Nenhum bairro cadastrado</h6><p>Utilize o formulário abaixo para adicionar bairros.</p>`;
                list.appendChild(emptyDiv);
            } else {
                Object.keys(dataObj).sort().forEach(key => {
                    const row = document.createElement('div'); 
                    row.className = 'state-edit-row';
                    row.innerHTML = `
                        <input type="text" class="form-control form-control-sm fw-bold me-2" style="width:150px" value="${key}" onchange="renameDataKey('${key}', this.value)">
                        <input type="number" class="form-control form-control-sm me-2" value="${dataObj[key]}" onchange="updateDataValue('${key}', this.value)">
                        <button class="btn btn-outline-danger btn-sm p-1" style="font-size:10px" onclick="deleteDataKey('${key}')"><i class="fas fa-trash"></i></button>
                    `;
                    list.appendChild(row);
                });
            }
        }
        updateAdminCoords();
        updateIDHList();
    }

    function updateIDHList() {
        const list = document.getElementById('idh-edit-list'); 
        if (!list) return; 
        list.innerHTML = '';
        
        if (Object.keys(dadosIDHBairros).length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-state';
            emptyDiv.innerHTML = `<i class="fas fa-chart-line"></i><h6>Nenhum IDH cadastrado</h6><p>Utilize o formulário abaixo para adicionar IDH aos bairros.</p>`;
            list.appendChild(emptyDiv);
        } else {
            Object.keys(dadosIDHBairros).sort().forEach(bairro => {
                const visitas = visitasBairros[bairro] || 0;
                const row = document.createElement('div'); 
                row.className = 'idh-edit-row';
                row.innerHTML = `
                    <small class="flex-grow-1" style="font-size:10px"><b>${bairro}</b> (${visitas} visitas)</small>
                    <input type="number" step="0.001" min="0" max="1" class="form-control form-control-sm mx-1" style="width:70px" value="${dadosIDHBairros[bairro]}" onchange="updateIDHValue('${bairro}', this.value)">
                    <button class="btn btn-outline-danger btn-sm p-1" style="font-size:10px" onclick="deleteBairro('${bairro}')"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(row);
            });
        }
        checkMissingIDH();
    }

    function updateIDHBairroSelect() {
        const select = document.getElementById('idh-bairro-select');
        if (!select) return;
        
        select.innerHTML = '<option value="">Selecione um bairro...</option>';
        Object.keys(visitasBairros).sort().forEach(bairro => {
            const option = document.createElement('option');
            option.value = bairro;
            option.textContent = bairro;
            select.appendChild(option);
        });
    }

    function addOrUpdateIDH() {
        const select = document.getElementById('idh-bairro-select');
        const idhInput = document.getElementById('new-idh-value');
        const bairro = select.value;
        const idhVal = parseFloat(idhInput.value);
        
        if (!bairro) { 
            silentLog('Selecione um bairro.', "warning"); 
            return; 
        }
        
        if (isNaN(idhVal) || idhVal < 0 || idhVal > 1) { 
            silentLog('IDH deve estar entre 0 e 1.', "warning"); 
            return; 
        }
        
        dadosIDHBairros[bairro] = idhVal;
        rebuildIDHIndex();
        updateIDHList();
        updateMap();
        updateComparisonPanel();
        saveToDatabase();
        addToVersionHistory('IDH', `IDH do bairro ${bairro} atualizado para ${idhVal.toFixed(3)}`);
        
        select.value = '';
        idhInput.value = '';
        silentLog(`IDH do bairro "${bairro}" atualizado para ${idhVal.toFixed(3)}`, "success");
    }

    function updateAdminCoords() {
        const list = document.getElementById('coords-list'); 
        if (!list) return;
        
        let coordsObj = (adminLevel === 'brasil') ? manualCoords : (adminLevel === 'ceara' ? manualCoordsMunicipios : manualCoordsBairros);
        
        if (Object.keys(coordsObj).length === 0) {
            list.innerHTML = '<div class="empty-state"><i class="fas fa-map-pin"></i><h6>Sem coordenadas</h6><p>Arraste os labels no mapa para definir posições.</p></div>';
        } else {
            list.innerHTML = '<div class="mb-2"><small class="text-muted">Arraste os labels no mapa para atualizar:</small></div><pre>' + JSON.stringify(coordsObj, null, 2) + '</pre>';
        }
    }

    async function updateDataValue(key, val) {
        const intVal = parseInt(val) || 0;
        
        if (adminLevel === 'brasil') { 
            visitasEstados[key] = intVal; 
        }
        else if (adminLevel === 'ceara') { 
            visitasMunicipios[key] = intVal; 
        }
        else { 
            const normKey = normalizeBairroName(key); 
            let found = false; 
            for (let k in visitasBairros) { 
                if (normalizeBairroName(k) === normKey) { 
                    visitasBairros[k] = intVal; 
                    found = true; 
                    break; 
                } 
            } 
            if (!found) visitasBairros[key] = intVal; 
        }
        
        calculateSums();
        updateMap();
        updateRanking();
        if (isPresentationMode) updatePresentationCard();
        await saveToDatabase();
        addToVersionHistory('Atualização', `${key} alterado para ${intVal}`);
        silentLog(`Valor atualizado: ${key} = ${intVal}`);
    }

    async function updateEstadoSigla(oldSigla, newSigla) {
        if (!newSigla || oldSigla === newSigla) return;
        
        newSigla = newSigla.toUpperCase().substring(0, 2);
        
        if (visitasEstados[oldSigla] !== undefined) { 
            visitasEstados[newSigla] = visitasEstados[oldSigla]; 
            delete visitasEstados[oldSigla]; 
        }
        
        if (manualCoords[oldSigla] !== undefined) { 
            manualCoords[newSigla] = manualCoords[oldSigla]; 
            delete manualCoords[oldSigla]; 
        }
        
        if (estadosMetadata[oldSigla] !== undefined) { 
            estadosMetadata[newSigla] = estadosMetadata[oldSigla]; 
            delete estadosMetadata[oldSigla]; 
        }
        
        updateAdminList();
        updateMap();
        updateRanking();
        if (isPresentationMode) updatePresentationCard();
        await saveToDatabase();
        addToVersionHistory('Renomeação', `Sigla de estado alterada de ${oldSigla} para ${newSigla}`);
        silentLog(`Sigla alterada para ${newSigla}`, "success");
    }

    async function updateEstadoNome(sigla, nome) {
        if (!nome) return;
        if (!estadosMetadata[sigla]) { 
            estadosMetadata[sigla] = {}; 
        }
        estadosMetadata[sigla].nome = nome;
        updateMap();
        updateRanking();
        if (isPresentationMode) updatePresentationCard();
        await saveToDatabase();
        silentLog(`Nome do estado ${sigla} atualizado para ${nome}`);
    }

    async function renameDataKey(oldKey, newKey) {
        if (!newKey || oldKey === newKey) return;
        
        let dataObj, coordsObj;
        
        if (adminLevel === 'brasil') { 
            dataObj = visitasEstados; 
            coordsObj = manualCoords; 
        }
        else if (adminLevel === 'ceara') { 
            dataObj = visitasMunicipios; 
            coordsObj = manualCoordsMunicipios; 
        }
        else { 
            dataObj = visitasBairros; 
            coordsObj = manualCoordsBairros; 
        }
        
        if (dataObj[oldKey] !== undefined) { 
            dataObj[newKey] = dataObj[oldKey]; 
            delete dataObj[oldKey]; 
        }
        
        if (coordsObj[oldKey] !== undefined) { 
            coordsObj[newKey] = coordsObj[oldKey]; 
            delete coordsObj[oldKey]; 
        }
        
        if (adminLevel === 'fortaleza' && dadosIDHBairros[oldKey] !== undefined) { 
            dadosIDHBairros[newKey] = dadosIDHBairros[oldKey]; 
            delete dadosIDHBairros[oldKey]; 
            rebuildIDHIndex(); 
        }
        
        updateAdminList(); 
        updateMap();
        updateRanking();
        if (isPresentationMode) updatePresentationCard();
        await saveToDatabase();
        addToVersionHistory('Renomeação', `${oldKey} renomeado para ${newKey}`);
        silentLog(`Renomeado: ${oldKey} -> ${newKey}`, "success");
    }

    async function deleteDataKey(key) {
        if (!confirm(`Deseja realmente excluir "${key}"?`)) return;
        
        if (adminLevel === 'brasil') { 
            delete visitasEstados[key]; 
            delete manualCoords[key]; 
            delete estadosMetadata[key]; 
        }
        else if (adminLevel === 'ceara') { 
            delete visitasMunicipios[key]; 
            delete manualCoordsMunicipios[key]; 
        }
        else if (adminLevel === 'fortaleza') { 
            delete visitasBairros[key]; 
            delete manualCoordsBairros[key]; 
            delete dadosIDHBairros[key]; 
            if (selectedItems.has(key)) selectedItems.delete(key); 
            rebuildIDHIndex(); 
        }
        
        updateAdminList();
        updateMap();
        updateComparisonPanel();
        updateRanking();
        await saveToDatabase();
        addToVersionHistory('Exclusão', `${key} removido`);
        silentLog(`Excluído: ${key}`, "success");
    }

    function updateIDHValue(bairro, val) {
        const valor = parseFloat(val);
        if (valor >= 0 && valor <= 1) { 
            dadosIDHBairros[bairro] = valor; 
            rebuildIDHIndex(); 
            updateMap(); 
            updateComparisonPanel(); 
            saveToDatabase(); 
            silentLog(`IDH de ${bairro} atualizado para ${valor}`);
        }
    }

    async function addNewEstado() {
        const siglaInput = document.getElementById('new-estado-sigla');
        const nomeInput = document.getElementById('new-estado-nome');
        const visitasInput = document.getElementById('new-estado-visitas');
        
        let sigla = siglaInput.value.trim().toUpperCase();
        const nome = nomeInput.value.trim();
        const visitasVal = parseInt(visitasInput.value) || 0;
        
        if (!sigla) { 
            silentLog('Digite a sigla do estado (ex: SP)', "warning"); 
            return; 
        }
        
        sigla = sigla.substring(0, 2);
        
        if (visitasEstados[sigla] !== undefined) { 
            if (!confirm(`Estado ${sigla} já existe. Deseja atualizar os dados?`)) return; 
        }
        
        visitasEstados[sigla] = visitasVal;
        
        if (nome) { 
            if (!estadosMetadata[sigla]) estadosMetadata[sigla] = {}; 
            estadosMetadata[sigla].nome = nome; 
        }
        
        if (!manualCoords[sigla] && statesData) { 
            const feature = statesData.features.find(f => (f.properties.sigla || f.id) === sigla); 
            if (feature) { 
                const centroid = calculateCentroid(feature); 
                if (centroid) { 
                    manualCoords[sigla] = centroid; 
                } 
            } 
        }
        
        if (!manualCoords[sigla]) { 
            const center = map.getCenter(); 
            manualCoords[sigla] = [parseFloat(center.lat.toFixed(4)), parseFloat(center.lng.toFixed(4))]; 
        }
        
        siglaInput.value = ''; 
        nomeInput.value = ''; 
        visitasInput.value = '0';
        
        calculateSums();
        updateAdminList();
        updateMap();
        updateRanking();
        if (isPresentationMode) updatePresentationCard();
        await saveToDatabase();
        addToVersionHistory('Adição', `Estado ${sigla} adicionado`);
        silentLog(`Estado ${sigla}${nome ? ' - ' + nome : ''} adicionado com sucesso!`, "success");
    }

    async function addNewMunicipio() {
        const nameInput = document.getElementById('new-municipio-name');
        const visitasInput = document.getElementById('new-municipio-visitas');
        
        const name = nameInput.value.trim();
        const visitasVal = parseInt(visitasInput.value) || 0;
        
        if (name) {
            visitasMunicipios[name] = visitasVal;
            
            let coordsCalculated = false;
            if (cearaData && cearaData.features) {
                const feature = cearaData.features.find(f => f.properties.name === name || f.properties.Nome === name || f.properties.NOME === name);
                if (feature) { 
                    const centroid = calculateCentroid(feature); 
                    if (centroid) { 
                        manualCoordsMunicipios[name] = centroid; 
                        coordsCalculated = true; 
                    } 
                }
            }
            
            if (!coordsCalculated && !manualCoordsMunicipios[name]) { 
                manualCoordsMunicipios[name] = [-4.5, -39.5]; 
            }
            
            nameInput.value = ''; 
            visitasInput.value = '0';
            
            if (autoCalculate) { 
                calculateSums(); 
            }
            
            updateAdminList();
            updateMap();
            updateRanking();
            await saveToDatabase();
            addToVersionHistory('Adição', `Município ${name} adicionado`);
            silentLog(`Município "${name}" adicionado com sucesso!`, "success");
        } else { 
            silentLog('Preencha o nome do município.', "warning"); 
        }
    }

    async function addNewBairro() {
        const nameInput = document.getElementById('new-bairro-name');
        const visitasInput = document.getElementById('new-bairro-visitas');
        
        const name = nameInput.value.trim().toUpperCase();
        const visitasVal = parseInt(visitasInput.value) || 0;
        
        if (!name) { 
            silentLog('Preencha o nome do bairro.', "warning"); 
            return; 
        }
        
        const normName = normalizeBairroName(name);
        let exists = false;
        for (let key in visitasBairros) { 
            if (normalizeBairroName(key) === normName) { 
                exists = true; 
                break; 
            } 
        }
        
        if (exists) { 
            if (!confirm(`Bairro "${name}" já existe. Deseja atualizar os dados?`)) return; 
        }
        
        visitasBairros[name] = visitasVal;
        
        let coordsCalculated = false;
        if (fortalezaData && fortalezaData.features) {
            const feature = fortalezaData.features.find(f => { 
                const fName = f.properties.bairro || f.properties.NOME_BAIRRO || f.properties.name || f.properties.Nome || f.properties.NOME; 
                return normalizeBairroName(fName) === normName; 
            });
            if (feature) { 
                const centroid = calculateCentroid(feature); 
                if (centroid) { 
                    manualCoordsBairros[name] = centroid; 
                    coordsCalculated = true; 
                } 
            }
        }
        
        if (!coordsCalculated && !manualCoordsBairros[name]) { 
            const center = map.getCenter(); 
            manualCoordsBairros[name] = [parseFloat(center.lat.toFixed(4)), parseFloat(center.lng.toFixed(4))]; 
        }
        
        nameInput.value = ''; 
        visitasInput.value = '0';
        
        if (autoCalculate) { 
            calculateSums(); 
        }
        
        updateAdminList();
        updateIDHBairroSelect();
        updateMap();
        updateRanking();
        if (isPresentationMode) updatePresentationCard();
        await saveToDatabase();
        addToVersionHistory('Adição', `Bairro ${name} adicionado`);
        silentLog(`Bairro "${name}" adicionado! Agora defina o IDH na aba "IDH".`, "success");
    }

    function checkMissingIDH() {
        if (currentLevel === 'fortaleza' && fortalezaData) {
            const missing = detectarBairrosSemIDH(fortalezaData);
            document.getElementById('idh-warning').style.display = missing.length > 0 ? 'block' : 'none';
        }
    }

    function toggleStateLabels(show) { 
        if (currentLevel === 'brasil') showNumberLabelsBrasil = show;
        else if (currentLevel === 'ceara') showNumberLabelsCeara = show;
        else showNumberLabelsFortaleza = show;
        renderLabels();
        saveToDatabase();
        silentLog(`Exibir números: ${show}`);
    }
    
    function toggleStateNameLabels(show) { 
        if (currentLevel === 'brasil') showNameLabelsBrasil = show;
        else if (currentLevel === 'ceara') showNameLabelsCeara = show;
        else showNameLabelsFortaleza = show;
        renderLabels();
        saveToDatabase();
        silentLog(`Exibir nomes: ${show}`);
    }

    function toggleBairroSelection(name, event) {
        if (event) event.stopPropagation();
        selectItem(name, true);
    }

    function updateStyle(type, val) {
        if (type === 'size') { 
            labelFontSize = val; 
            document.getElementById('fontSizeVal').textContent = val + 'px'; 
            document.documentElement.style.setProperty('--label-font-size', val + 'px');
        }
        if (type === 'weight') {
            labelFontWeight = val;
            document.getElementById('fontWeightSelect').value = val;
            const labels = document.querySelectorAll('.state-label');
            labels.forEach(l => l.style.fontWeight = val);
        }
        if (type === 'color') {
            labelFontColor = val;
            document.getElementById('fontColorInput').value = val;
            const labels = document.querySelectorAll('.state-label');
            labels.forEach(l => l.style.color = val);
        }
        if (type === 'selectionBox') { 
            showSelectionBoxFortaleza = val; 
            if (!val) selectedItems.clear(); 
            updateMap(); 
        }
        saveToDatabase();
        silentLog(`Estilo atualizado: ${type} = ${val}`);
    }

    function updateSystemTitle() {
        const newTitle = document.getElementById('systemTitleInput').value.trim();
        if (newTitle) { 
            systemTitle = newTitle; 
            document.getElementById('main-system-title').textContent = systemTitle; 
            saveToDatabase(); 
            addToVersionHistory('Sistema', `Título alterado para ${newTitle}`);
            silentLog('Título atualizado!', "success"); 
        }
    }

    function toggleAutoCalculate(checked) {
        autoCalculate = checked;
        if (autoCalculate) { 
            calculateSums(); 
            updateMap(); 
        }
        saveToDatabase();
        silentLog(`Cálculo automático ${autoCalculate ? 'ativado' : 'desativado'}`, "info");
    }

    function toggleAutoBackup(checked) {
        autoBackup = checked;
        saveToDatabase();
        silentLog(`Backup automático ${checked ? 'ativado' : 'desativado'}`, "info");
    }

    function showEstadoDetails(sigla) {
        const visitas = visitasEstados[sigla] || 0;
        const nome = estadosMetadata[sigla]?.nome || sigla;
        currentDetailItem = { name: sigla, level: 'brasil', visitas: visitas, nomeCompleto: nome };
        showDetails();
    }

    function importGeoJSON() { 
        try { 
            const geoData = JSON.parse(document.getElementById('geoJsonImportArea').value); 
            
            if (currentLevel === 'brasil') statesData = geoData; 
            else if (currentLevel === 'ceara') cearaData = geoData; 
            else if (currentLevel === 'fortaleza') fortalezaData = geoData; 
            
            switchLevel(currentLevel); 
            addToVersionHistory('GeoJSON', 'Novo GeoJSON importado');
            silentLog('GeoJSON importado!', "success"); 
        } catch (e) { 
            silentLog('Erro no GeoJSON: ' + e.message, "error"); 
        } 
    }

    function saveAll() { 
        updateMap(); 
        saveToDatabase(); 
        silentLog('Alterações salvas!', "success"); 
    }
    
    function takePerfectPrint() { 
        $('.sidebar, #adminPanel, .leaflet-control-zoom').hide(); 
        fitMap(); 
        setTimeout(() => { 
            silentLog('Pronto para o print!', "info"); 
        }, 1000); 
    }
    
    function resetPositions() { 
        if (confirm('Resetar posições?')) location.reload(); 
    }

    function updateSidebarTable() {
        const bBody = document.getElementById('stats-body'); 
        bBody.innerHTML = '';
        
        let dataObj = (currentLevel === 'brasil') ? visitasEstados : (currentLevel === 'ceara' ? visitasMunicipios : visitasBairros);
        
        if (Object.keys(dataObj).length === 0) { 
            bBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">Nenhum dado cadastrado</td></tr>'; 
            return; 
        }
        
        Object.entries(dataObj).sort((a,b) => b[1]-a[1]).forEach(([name, v]) => {
            if (v >= 0) {
                let shouldDisplay = true;
                
                if (activeFilter) {
                    if (activeFilter.type === 'visitas' && !isStateInFilter(v)) { 
                        shouldDisplay = false; 
                    }
                    if (currentLevel === 'fortaleza' && activeFilter.type === 'idh') { 
                        const idh = getIDHForBairro(name); 
                        if (!isIDHInFilter(idh)) { 
                            shouldDisplay = false; 
                        } 
                    }
                } else { 
                    if (v === 0) shouldDisplay = false; 
                }
                
                if (shouldDisplay) {
                    let idhCell = '';
                    if (currentLevel === 'fortaleza') { 
                        const idh = getIDHForBairro(name); 
                        idhCell = `<td style="text-align:center"><span class="badge-idh">${(idh !== null) ? idh.toFixed(3) : 'N/D'}</span></td>`; 
                    }
                    
                    let displayName = name;
                    if (currentLevel === 'brasil' && estadosMetadata[name]) { 
                        displayName = `${name} - ${estadosMetadata[name].nome || ''}`; 
                    }
                    
                    const row = `<tr onclick="handleTableRowClick('${name}')"><td><b>${displayName}</b></td><td style="text-align:right"><span class="badge-count">${v.toLocaleString()}</span></td>${idhCell}</tr>`;
                    bBody.innerHTML += row;
                }
            }
        });
    }

    function handleTableRowClick(name) {
        if (currentLevel === 'fortaleza') {
            const normName = normalizeBairroName(name);
            let v = 0;
            for (let key in visitasBairros) { 
                if (normalizeBairroName(key) === normName) { 
                    v = visitasBairros[key]; 
                    break; 
                } 
            }
            currentDetailItem = { name: name, level: 'fortaleza', visitas: v, idh: getIDHForBairro(name) };
            showDetails();
        } else if (currentLevel === 'brasil') {
            const v = visitasEstados[name] || 0;
            const nomeCompleto = estadosMetadata[name]?.nome || name;
            currentDetailItem = { name: name, level: 'brasil', visitas: v, nomeCompleto: nomeCompleto };
            showDetails();
        } else if (currentLevel === 'ceara') {
            const v = visitasMunicipios[name] || 0;
            currentDetailItem = { name: name, level: 'ceara', visitas: v };
            showDetails();
        }
    }

    const legendCtrl = L.control({position: 'bottomright'});
    legendCtrl.onAdd = function() { return L.DomUtil.create('div', 'legend'); };
    legendCtrl.addTo(map);

    function updateLegend() {
        let div = document.querySelector('.legend');
        if (!div) return;
        
        if (currentLevel === 'fortaleza' && currentViewMode === 'idh') {
            div.innerHTML = '<div style="margin-bottom:8px; font-weight:800; color:var(--text-dark); font-size:14px;">Filtrar por IDH</div>';
            const grades = [ 
                { label: 'Muito Alto (≥0.800)', color: '#27ae60' }, 
                { label: 'Alto (0.700-0.799)', color: '#52be80' }, 
                { label: 'Médio (0.400-0.699)', color: '#f39c12' }, 
                { label: 'Baixo (<0.400)', color: '#e74c3c' } 
            ];
            
            grades.forEach(g => {
                const item = L.DomUtil.create('div', 'legend-item', div);
                item.innerHTML = `<i style="background:${g.color}"></i> <span>${g.label}</span>`;
                item.onclick = function() { 
                    if (activeFilter && activeFilter.label === g.label) { 
                        activeFilter = null; 
                        item.classList.remove('active'); 
                    } else { 
                        activeFilter = { type: 'idh', label: g.label }; 
                        document.querySelectorAll('.legend-item').forEach(i => i.classList.remove('active')); 
                        item.classList.add('active'); 
                    } 
                    updateMap(); 
                };
            });
        } else {
            div.innerHTML = '<div style="margin-bottom:8px; font-weight:800; color:var(--text-dark); font-size:14px;">Filtrar por Visitas</div>';
            const grades = [ 
                { label: '0-20', min: 0 }, 
                { label: '21-50', min: 21 }, 
                { label: '51-100', min: 51 }, 
                { label: '101-500', min: 101 }, 
                { label: '> 500', min: 501 } 
            ];
            
            grades.forEach(g => {
                const color = getStateColor(g.min + 1); 
                const item = L.DomUtil.create('div', 'legend-item', div);
                item.innerHTML = `<i style="background:${color}"></i> <span>${g.label}</span>`;
                item.onclick = function() { 
                    if (activeFilter && activeFilter.label === g.label) { 
                        activeFilter = null; 
                        item.classList.remove('active'); 
                    } else { 
                        activeFilter = { type: 'visitas', label: g.label }; 
                        document.querySelectorAll('.legend-item').forEach(i => i.classList.remove('active')); 
                        item.classList.add('active'); 
                    } 
                    updateMap(); 
                };
            });
        }
    }

    function updateTotalCounter() {
        const totalLabel = document.getElementById('totalLabel');
        const totalValue = document.getElementById('totalValue');
        const totalSub = document.getElementById('totalSub');
        let total = 0, count = 0;
        
        if (currentLevel === 'brasil') {
            total = Object.values(visitasEstados).reduce((a, b) => a + b, 0);
            count = Object.keys(visitasEstados).length;
            totalLabel.textContent = 'Total de Visitas no Brasil';
            totalSub.textContent = `Estados: ${count}`;
        } else if (currentLevel === 'ceara') {
            total = Object.values(visitasMunicipios).reduce((a, b) => a + b, 0);
            count = Object.keys(visitasMunicipios).length;
            totalLabel.textContent = 'Total de Visitas no Ceará';
            totalSub.textContent = `Municípios: ${count}`;
        } else {
            total = Object.values(visitasBairros).reduce((a, b) => a + b, 0);
            count = Object.keys(visitasBairros).length;
            totalLabel.textContent = 'Total de Visitas em Fortaleza';
            totalSub.textContent = `Bairros: ${count}`;
        }
        
        totalValue.textContent = total.toLocaleString('pt-BR');
    }

    // ==================== FUNÇÕES DE UTILIDADE ====================
    function updateContainerVisibility(level) {
        silentLog(`Atualizando visibilidade dos containers para o nível: ${level}`);
        const addEstadoContainer = document.getElementById('add-estado-container');
        const addMunicipioContainer = document.getElementById('add-municipio-container');
        const addBairroContainer = document.getElementById('add-bairro-container');
        const totalEstadosInfo = document.getElementById('total-estados-info');
        
        [addEstadoContainer, addMunicipioContainer, addBairroContainer, totalEstadosInfo].forEach(container => {
            if (container) container.classList.remove('container-hidden', 'container-visible');
        });
        
        if (level === 'brasil') {
            if (addEstadoContainer) { addEstadoContainer.classList.add('container-visible'); addEstadoContainer.style.display = 'block'; }
            if (addMunicipioContainer) { addMunicipioContainer.classList.add('container-hidden'); addMunicipioContainer.style.display = 'none'; }
            if (addBairroContainer) { addBairroContainer.classList.add('container-hidden'); addBairroContainer.style.display = 'none'; }
            if (totalEstadosInfo) { totalEstadosInfo.classList.add('container-visible'); totalEstadosInfo.style.display = 'block'; }
        } else if (level === 'ceara') {
            if (addEstadoContainer) { addEstadoContainer.classList.add('container-hidden'); addEstadoContainer.style.display = 'none'; }
            if (addMunicipioContainer) { addMunicipioContainer.classList.add('container-visible'); addMunicipioContainer.style.display = 'block'; }
            if (addBairroContainer) { addBairroContainer.classList.add('container-hidden'); addBairroContainer.style.display = 'none'; }
            if (totalEstadosInfo) { totalEstadosInfo.classList.add('container-hidden'); totalEstadosInfo.style.display = 'none'; }
        } else if (level === 'fortaleza') {
            if (addEstadoContainer) { addEstadoContainer.classList.add('container-hidden'); addEstadoContainer.style.display = 'none'; }
            if (addMunicipioContainer) { addMunicipioContainer.classList.add('container-hidden'); addMunicipioContainer.style.display = 'none'; }
            if (addBairroContainer) { addBairroContainer.classList.add('container-visible'); addBairroContainer.style.display = 'block'; }
            if (totalEstadosInfo) { totalEstadosInfo.classList.add('container-hidden'); totalEstadosInfo.style.display = 'none'; }
        }
    }

    function updateIDHTabVisibility() {
        const idhTabItem = document.getElementById('idh-tab-item');
        const dataSourcePanel = document.getElementById('data-source-panel');
        if (currentLevel === 'fortaleza') {
            if (idhTabItem) idhTabItem.style.display = 'block';
            dataSourcePanel.style.display = (currentViewMode === 'idh') ? 'block' : 'none';
        } else {
            if (idhTabItem) idhTabItem.style.display = 'none';
            dataSourcePanel.style.display = 'none';
            if (document.getElementById('idh-tab') && document.getElementById('idh-tab').classList.contains('active')) {
                const dataTab = document.getElementById('data-tab');
                if (dataTab) bootstrap.Tab.getOrCreateInstance(dataTab).show();
            }
        }
    }

    function initializeAdminContainers() {
        const addEstadoContainer = document.getElementById('add-estado-container');
        const addMunicipioContainer = document.getElementById('add-municipio-container');
        const addBairroContainer = document.getElementById('add-bairro-container');
        const totalEstadosInfo = document.getElementById('total-estados-info');
        
        if (!addEstadoContainer || !addMunicipioContainer || !addBairroContainer) {
            silentLog("Containers não encontrados!", 'error');
            return;
        }
        
        addEstadoContainer.style.display = 'block';
        addMunicipioContainer.style.display = 'block';
        addBairroContainer.style.display = 'block';
        if (totalEstadosInfo) totalEstadosInfo.style.display = 'block';
        
        [addEstadoContainer, addMunicipioContainer, addBairroContainer, totalEstadosInfo].forEach(container => {
            if (container) container.classList.remove('container-hidden', 'container-visible');
        });
        
        updateContainerVisibility('brasil');
        updateIDHTabVisibility();
    }

    function clearImportArea() {
        document.getElementById('autoImportArea').value = '';
        document.getElementById('importPreview').innerHTML = '<small class="text-muted">Pré-visualização:</small><div id="importPreviewItems"></div>';
        document.getElementById('duplicateResolution').style.display = 'none';
    }

    // ==================== FUNÇÕES DE TOAST E INDICADORES ====================
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i><span class="message">${message}</span><span class="close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></span>`;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
        silentLog(`Toast: ${message}`, type);
    }

    let saveTimeout;
    function showSavingIndicator(show = true) {
        const indicator = document.getElementById('savingIndicator');
        if (show) { 
            indicator.style.display = 'flex'; 
            clearTimeout(saveTimeout); 
            saveTimeout = setTimeout(() => indicator.style.display = 'none', 2000); 
        } else { 
            indicator.style.display = 'none'; 
        }
    }

    function showProgress(show) {
        const progress = document.getElementById('importProgress');
        const bar = document.getElementById('importProgressBar');
        if (show) {
            progress.style.display = 'block';
            bar.style.width = '50%';
            setTimeout(() => bar.style.width = '75%', 200);
        } else {
            bar.style.width = '100%';
            setTimeout(() => {
                progress.style.display = 'none';
                bar.style.width = '0%';
            }, 500);
        }
    }

    // ==================== CORREÇÕES ESPECÍFICAS ====================
    function applySpecificCorrections() {
        silentLog("Aplicando correções específicas...");
        
        if (manualCoordsMunicipios && manualCoordsMunicipios["Itapagé"] !== undefined) {
            silentLog("Corrigindo 'Itapagé' para 'Itapajé' em manualCoordsMunicipios");
            manualCoordsMunicipios["Itapajé"] = manualCoordsMunicipios["Itapagé"];
            delete manualCoordsMunicipios["Itapagé"];
        }
        
        if (visitasMunicipios && visitasMunicipios["Itapagé"] !== undefined) {
            silentLog("Corrigindo 'Itapagé' para 'Itapajé' em visitasMunicipios");
            visitasMunicipios["Itapajé"] = visitasMunicipios["Itapagé"];
            delete visitasMunicipios["Itapagé"];
        }
        
        rebuildIDHIndex();
        
        saveToDatabase().then(() => {
            silentLog("Correções aplicadas e salvas com sucesso!", "success");
        }).catch(error => {
            silentLog(`Erro ao salvar correções: ${error}`, "error");
        });
        
        updateAdminList();
        updateMap();
    }

    // ==================== INICIALIZAÇÃO ====================
    async function initMap() {
        try {
            silentLog("Inicializando mapa...");
            
            // Garantia extra para versionHistory
            if (!Array.isArray(window.versionHistory)) window.versionHistory = [];
            
            silentLog("Carregando dados do banco...");
            await loadFromDatabase();
            silentLog("Dados carregados com sucesso", "success");
            
            rebuildIDHIndex();
            calculateSums();
            
            document.getElementById('main-system-title').textContent = systemTitle;
            document.getElementById('toggleAutoCalculate').checked = autoCalculate;
            document.getElementById('toggleAutoBackup').checked = autoBackup;
            
            if (document.getElementById('featureStatisticalAnalysis')) {
                document.getElementById('featureStatisticalAnalysis').checked = featureToggles.statisticalAnalysis;
            }
            
            document.getElementById('fontSizeRange').value = labelFontSize;
            document.getElementById('fontSizeVal').textContent = labelFontSize + 'px';
            document.getElementById('fontWeightSelect').value = labelFontWeight;
            document.getElementById('fontColorInput').value = labelFontColor;
            
            const paddingMatch = balloonPadding.match(/(\d+)px/);
            if (paddingMatch && paddingMatch[1]) {
                document.getElementById('balloonSizeRange').value = parseInt(paddingMatch[1]);
                document.getElementById('balloonSizeVal').textContent = balloonPadding;
            }
            
            toggleStatisticalFeature(featureToggles.statisticalAnalysis);
            changeTheme(currentTheme);
            
            if (document.getElementById('featurePresentationMode')) {
                document.getElementById('featurePresentationMode').checked = featureToggles.presentationMode;
            }
            togglePresentationFeature(featureToggles.presentationMode);
            
            if (document.getElementById('toggleSelectionBox')) { 
                document.getElementById('toggleSelectionBox').checked = showSelectionBoxFortaleza; 
            }
            
            initializeAdminContainers();
            
            if (importHistory.length > 0) {
                document.getElementById('dataVersionHistory').style.display = 'block';
                document.getElementById('lastImportTimestamp').textContent = importHistory[importHistory.length-1].timestamp 
                    ? new Date(importHistory[importHistory.length-1].timestamp).toLocaleString('pt-BR') 
                    : 'Data desconhecida';
            }
            
            try {
                updateVersionHistoryDisplay();
            } catch (e) {
                silentLog("Erro ao atualizar display de histórico: " + e, "error");
            }
            
            try {
                silentLog("Carregando dados geográficos dos estados...");
                const resBrasil = await fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson'); 
                statesData = await resBrasil.json();
                silentLog(`Estados carregados: ${statesData.features.length} features`, "success");
                
                silentLog("Carregando dados geográficos dos municípios do Ceará...");
                const resMun = await fetch('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-23-mun.json'); 
                cearaData = await resMun.json();
                silentLog(`Municípios carregados: ${cearaData.features.length} features`, "success");
                
                silentLog("Carregando dados geográficos dos bairros de Fortaleza...");
                const resFortaleza = await fetch('https://raw.githubusercontent.com/HerivaldoJr/mapa-fortaleza-infancia/refs/heads/main/Bairros_de_Fortaleza.geojson');
                fortalezaData = await resFortaleza.json();
                silentLog(`Bairros carregados: ${fortalezaData.features.length} features`, "success");
            } catch (e) {
                silentLog(`Erro ao carregar GeoJSONs: ${e}`, 'error');
                showToast("Erro ao carregar dados do mapa. Verifique sua conexão.", "error");
                statesData = { type: "FeatureCollection", features: [] };
                cearaData = { type: "FeatureCollection", features: [] };
                fortalezaData = { type: "FeatureCollection", features: [] };
            }
            
            applySpecificCorrections();
            
            ensureAllStateCoords();
            ensureAllMunicipioCoords();
            ensureAllBairroCoords();
            
            await switchLevel('brasil');
            checkMissingIDH();
            
            map.on('click', function(e) {
                if (e.originalEvent.target && (e.originalEvent.target.classList?.contains('leaflet-interactive') || e.originalEvent.target.tagName === 'path')) { 
                    return; 
                }
                
                if (selectedItems.size > 0) {
                    selectedItems.clear();
                    if (geojsonLayer) { 
                        geojsonLayer.eachLayer(l => { 
                            geojsonLayer.resetStyle(l); 
                            l.closePopup(); 
                        }); 
                    }
                    if (customBairrosLayer) { 
                        customBairrosLayer.eachLayer(l => { 
                            customBairrosLayer.resetStyle(l); 
                            l.closePopup(); 
                        }); 
                    }
                    updateMap();
                    updateComparisonPanel();
                }
            });
            
            silentLog("Sistema carregado com sucesso!", 'success');
            showToast('Sistema carregado com sucesso!', 'success');
            
        } catch (e) { 
            silentLog(`Erro fatal na inicialização: ${e}`, "error");
            showToast('Erro crítico ao iniciar o sistema. Recarregue a página.', "error");
        }
    }

    $(document).ready(() => { 
        initMap(); 
        document.getElementById('footer-year').textContent = new Date().getFullYear(); 
    });
</script>
</body>
</html>
